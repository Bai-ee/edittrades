<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Scanner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Mobile-first dark theme - no gradients or glows */
    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #2a2a2a;
      --text-primary: #f5f5f5;
      --text-secondary: #a0a0a0;
      --border: #333333;
      --accent-long: #10b981;
      --accent-short: #ef4444;
      --accent-neutral: #6b7280;
    }
    
    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    
    /* Remove all gradients and glows */
    * {
      box-shadow: none !important;
    }
    
    .card {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border);
    }
    
    .btn-primary {
      background-color: var(--text-primary);
      color: var(--bg-primary);
      border: 1px solid var(--text-primary);
    }
    
    .btn-primary:hover {
      background-color: var(--text-secondary);
      border-color: var(--text-secondary);
    }
    
    .btn-secondary {
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background-color: var(--bg-secondary);
    }
    
    .status-long { color: var(--accent-long); }
    .status-short { color: var(--accent-short); }
    .status-neutral { color: var(--accent-neutral); }
    
    .coin-card {
      border-left: 3px solid var(--border);
    }
    
    .coin-card.has-trade-long {
      border-left-color: var(--accent-long);
    }
    
    .coin-card.has-trade-short {
      border-left-color: var(--accent-short);
    }
    
    /* Mobile optimizations */
    .compact-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.5rem;
    }
    
    .tf-badge {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      border: 1px solid var(--border);
      background-color: var(--bg-tertiary);
    }
    
    @media (max-width: 640px) {
      body {
        font-size: 14px;
      }
      
      .compact-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body class="min-h-screen">
  
  <!-- Header -->
  <header class="border-b" style="border-color: var(--border); background-color: var(--bg-secondary);">
    <div class="max-w-2xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <h1 class="text-lg font-bold">Trading Scanner</h1>
        <button 
          id="menuBtn" 
          onclick="toggleMenu()"
          class="btn-secondary px-3 py-1 text-sm rounded"
        >
          Menu
        </button>
      </div>
    </div>
  </header>

  <!-- Collapsible Menu -->
  <div id="menu" class="hidden border-b" style="border-color: var(--border); background-color: var(--bg-tertiary);">
    <div class="max-w-2xl mx-auto px-4 py-3 space-y-2">
      <a href="/scanner.html" class="block btn-secondary px-3 py-2 text-sm rounded text-center">
        Market Scanner
      </a>
      <button onclick="window.location.reload()" class="w-full btn-secondary px-3 py-2 text-sm rounded">
        Refresh
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-2xl mx-auto px-4 py-6">
    
    <!-- Initial State: Scan Button -->
    <div id="initialState">
      <div class="text-center py-12">
        <h2 class="text-2xl font-bold mb-2">Quick Scan</h2>
        <p class="text-sm mb-8" style="color: var(--text-secondary);">
          Scan BTC, ETH & SOL for trading opportunities
        </p>
        <button 
          id="scanBtn" 
          onclick="scanMajorCoins()"
          class="btn-primary px-8 py-4 rounded text-lg font-medium transition w-full max-w-xs"
        >
          Scan Now
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="hidden text-center py-12">
      <div class="inline-block w-8 h-8 border-2 border-t-transparent rounded-full animate-spin mb-4" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
      <p style="color: var(--text-secondary);">Scanning markets...</p>
      <p id="scanProgress" class="text-sm mt-2" style="color: var(--text-secondary);"></p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden card rounded p-4 mb-4 border-red-600">
      <h3 class="font-bold mb-2 text-red-400">Error</h3>
      <p id="errorMessage" class="text-sm" style="color: var(--text-secondary);"></p>
    </div>

    <!-- Results Container -->
    <div id="resultsContainer" class="hidden">
      
      <!-- Summary Header -->
      <div class="mb-4 flex items-center justify-between">
        <div>
          <h2 class="text-lg font-bold">Results</h2>
          <p class="text-xs" style="color: var(--text-secondary);" id="lastUpdate"></p>
        </div>
        <button 
          id="copyAllBtn" 
          onclick="copyAllCoins()"
          class="btn-secondary px-3 py-2 text-sm rounded"
        >
          Copy All
        </button>
      </div>

      <!-- Opportunities Summary -->
      <div id="opportunitySummary" class="card rounded p-3 mb-4">
        <p class="text-sm font-medium mb-2">Trade Opportunities</p>
        <div id="opportunityList" class="text-xs space-y-1" style="color: var(--text-secondary);">
          <!-- Will be populated dynamically -->
        </div>
      </div>

      <!-- Coin Cards Container -->
      <div id="coinCards" class="space-y-3">
        <!-- Will be populated dynamically -->
      </div>

    </div>

  </main>

  <script>
    let scanResults = {};

    // Toggle menu
    function toggleMenu() {
      const menu = document.getElementById('menu');
      menu.classList.toggle('hidden');
    }

    // Main scan function
    async function scanMajorCoins() {
      const symbols = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT'];
      
      // Show loading
      document.getElementById('initialState').classList.add('hidden');
      document.getElementById('resultsContainer').classList.add('hidden');
      document.getElementById('errorState').classList.add('hidden');
      document.getElementById('loadingState').classList.remove('hidden');
      
      try {
        scanResults = {};
        
        for (let i = 0; i < symbols.length; i++) {
          const symbol = symbols[i];
          document.getElementById('scanProgress').textContent = `Scanning ${symbol}... (${i+1}/${symbols.length})`;
          
          const response = await fetch(`/api/analyze/${symbol}?intervals=4h,1h,15m,5m`);
          if (!response.ok) throw new Error(`Failed to fetch ${symbol}`);
          
          const data = await response.json();
          scanResults[symbol] = data;
        }
        
        // Display results
        displayResults();
        
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('resultsContainer').classList.remove('hidden');
        
      } catch (error) {
        console.error('Scan error:', error);
        showError(error.message || 'Failed to scan markets');
        document.getElementById('loadingState').classList.add('hidden');
      }
    }

    // Display scan results
    function displayResults() {
      const container = document.getElementById('coinCards');
      const opportunityList = document.getElementById('opportunityList');
      
      container.innerHTML = '';
      opportunityList.innerHTML = '';
      
      // Update timestamp
      document.getElementById('lastUpdate').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
      
      // Find opportunities
      const opportunities = [];
      
      for (const [symbol, data] of Object.entries(scanResults)) {
        const signal = data.tradeSignal;
        
        if (signal && signal.valid) {
          opportunities.push({
            symbol,
            direction: signal.direction,
            confidence: signal.confidence
          });
        }
        
        // Create coin card
        const card = createCoinCard(symbol, data);
        container.appendChild(card);
      }
      
      // Display opportunity summary
      if (opportunities.length > 0) {
        opportunities.forEach(opp => {
          const p = document.createElement('p');
          const dirClass = opp.direction === 'long' ? 'status-long' : 'status-short';
          p.innerHTML = `<span class="${dirClass} font-medium">${opp.symbol}</span> - ${opp.direction.toUpperCase()} (${(opp.confidence * 100).toFixed(0)}% confidence)`;
          opportunityList.appendChild(p);
        });
      } else {
        opportunityList.innerHTML = '<p style="color: var(--text-secondary);">No high-confidence setups found</p>';
      }
    }

    // Create individual coin card
    function createCoinCard(symbol, data) {
      const card = document.createElement('div');
      const signal = data.tradeSignal;
      const hasValidTrade = signal && signal.valid;
      const tradeClass = hasValidTrade ? 
        (signal.direction === 'long' ? 'has-trade-long' : 'has-trade-short') : '';
      
      card.className = `coin-card card rounded p-3 ${tradeClass}`;
      
      // Header
      const header = `
        <div class="flex items-center justify-between mb-3">
          <div>
            <h3 class="font-bold">${symbol.replace('USDT', '')}</h3>
            <p class="text-xs" style="color: var(--text-secondary);">
              $${data.currentPrice?.toLocaleString() || 'N/A'}
              <span class="${data.priceChange24h >= 0 ? 'status-long' : 'status-short'} ml-2">
                ${data.priceChange24h >= 0 ? '+' : ''}${data.priceChange24h?.toFixed(2) || 0}%
              </span>
            </p>
          </div>
          <button 
            onclick="copyCoinView('${symbol}')"
            class="btn-secondary px-3 py-1 text-xs rounded"
          >
            Copy
          </button>
        </div>
      `;
      
      // Trade signal
      let signalHtml = '';
      if (hasValidTrade) {
        const dirClass = signal.direction === 'long' ? 'status-long' : 'status-short';
        signalHtml = `
          <div class="mb-3 p-2 rounded" style="background-color: var(--bg-tertiary); border: 1px solid var(--border);">
            <p class="text-xs font-medium mb-1">
              <span class="${dirClass}">${signal.direction.toUpperCase()}</span>
              <span style="color: var(--text-secondary);"> â€¢ ${(signal.confidence * 100).toFixed(0)}% confidence</span>
            </p>
            <p class="text-xs" style="color: var(--text-secondary);">${signal.reason_summary || signal.reason}</p>
          </div>
        `;
      } else {
        signalHtml = `
          <div class="mb-3 p-2 rounded" style="background-color: var(--bg-tertiary); border: 1px solid var(--border);">
            <p class="text-xs status-neutral">${signal?.reason || 'No trade setup'}</p>
          </div>
        `;
      }
      
      // Timeframes grid
      const timeframes = ['4h', '1h', '15m', '5m'];
      const tfHtml = timeframes.map(tf => {
        const analysis = data.analysis?.[tf];
        if (!analysis || analysis.error) {
          return `<div class="tf-badge text-center"><div class="font-medium">${tf}</div><div style="color: var(--text-secondary);">N/A</div></div>`;
        }
        
        const trend = analysis.indicators?.analysis?.trend || 'UNKNOWN';
        const trendClass = trend === 'UPTREND' ? 'status-long' : 
                          trend === 'DOWNTREND' ? 'status-short' : 'status-neutral';
        
        return `
          <div class="tf-badge text-center">
            <div class="font-medium">${tf}</div>
            <div class="${trendClass} text-xs">${trend.replace('TREND', '').replace('FLAT', 'NEUTRAL')}</div>
          </div>
        `;
      }).join('');
      
      card.innerHTML = header + signalHtml + `<div class="compact-grid">${tfHtml}</div>`;
      
      return card;
    }

    // Copy single coin view
    function copyCoinView(symbol) {
      const data = scanResults[symbol];
      if (!data) {
        alert('No data available for ' + symbol);
        return;
      }
      
      const dashboardView = createDashboardView(data);
      const jsonString = JSON.stringify(dashboardView, null, 2);
      
      navigator.clipboard.writeText(jsonString).then(() => {
        showCopySuccess(`${symbol} copied!`);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy');
      });
    }

    // Copy all coins
    function copyAllCoins() {
      const allViews = {};
      
      for (const [symbol, data] of Object.entries(scanResults)) {
        allViews[symbol] = createDashboardView(data);
      }
      
      const jsonString = JSON.stringify(allViews, null, 2);
      
      navigator.clipboard.writeText(jsonString).then(() => {
        showCopySuccess('All coins copied!');
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy');
      });
    }

    // Create compact dashboard view
    function createDashboardView(data) {
      const view = {
        symbol: data.symbol,
        price: data.currentPrice,
        change24h: data.priceChange24h,
        signal: null,
        timeframes: {}
      };
      
      // Signal
      if (data.tradeSignal) {
        view.signal = {
          valid: data.tradeSignal.valid,
          direction: data.tradeSignal.direction || 'NO_TRADE',
          confidence: data.tradeSignal.confidence ? 
            parseFloat((data.tradeSignal.confidence * 100).toFixed(0)) : 0,
          reason: data.tradeSignal.reason_summary || data.tradeSignal.reason
        };
        
        if (data.tradeSignal.valid && data.tradeSignal.entry_zone) {
          view.signal.entryZone = {
            min: data.tradeSignal.entry_zone.min,
            max: data.tradeSignal.entry_zone.max
          };
          view.signal.stopLoss = data.tradeSignal.stop_loss;
          view.signal.targets = {
            tp1: data.tradeSignal.targets?.[0],
            tp2: data.tradeSignal.targets?.[1]
          };
        }
      }
      
      // Timeframes
      if (data.analysis) {
        for (const [interval, analysis] of Object.entries(data.analysis)) {
          if (analysis.error || !analysis.indicators) {
            view.timeframes[interval] = { error: analysis.error || 'No data' };
            continue;
          }
          
          const ind = analysis.indicators;
          view.timeframes[interval] = {
            trend: ind.analysis?.trend || 'UNKNOWN',
            ema21: ind.ema?.ema21 ? parseFloat(ind.ema.ema21.toFixed(2)) : null,
            stoch: {
              k: ind.stochRSI?.k ? parseFloat(ind.stochRSI.k.toFixed(1)) : null,
              condition: ind.stochRSI?.condition || 'UNKNOWN'
            },
            pullback: ind.analysis?.pullbackState || 'UNKNOWN'
          };
        }
      }
      
      view.timestamp = data.timestamp;
      return view;
    }

    // Show copy success toast
    function showCopySuccess(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 1rem;
        right: 1rem;
        background-color: var(--text-primary);
        color: var(--bg-primary);
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        z-index: 1000;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 2000);
    }

    // Show error
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorState').classList.remove('hidden');
    }
  </script>

</body>
</html>

