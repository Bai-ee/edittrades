<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EditTrades - 4H Trading Strategy Scanner</title>
  <link rel="icon" type="image/svg+xml" href="/logos/logo.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/edittrax-styles.css">
  <style>
    /* Prevent horizontal overflow */
    html, body {
      overflow-x: hidden;
      max-width: 100vw;
      box-sizing: border-box;
    }
    
    /* Particle background */
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
      background: linear-gradient(180deg, #000000 0%, #0a0a0a 100%);
    }
    
    * {
      box-sizing: border-box;
    }
    
    /* Additional component-specific styles */
    .details-row {
      display: none;
      background-color: black;
    }
    
    .details-row.expanded {
      display: table-row;
    }
    
    .details-row td {
      padding: 0.75rem !important;
      box-sizing: border-box;
      overflow: hidden;
    }
    
    .details-content-wrapper {
      width: 100%;
      max-width: 100%;
      overflow: hidden;
      box-sizing: border-box;
    }
    
    /* Mobile responsive table */
    @media (max-width: 768px) {
      .table-edittrax thead {
        display: none;
      }
      
      .coin-row {
        display: grid;
        grid-template-columns: 1fr;
        grid-template-areas:
          "coin"
          "signal-strategy"
          "action";
        gap: 0.5rem;
        padding: 1rem 0.5rem;
        border-bottom: 2px solid var(--color-yellow-75);
      }
      
      .coin-row td {
        padding: 0.5rem 0 !important;
        border: none;
        text-align: left !important;
      }
      
      .coin-row td:before {
        content: attr(data-label);
        font-weight: bold;
        display: block;
        margin-bottom: 0.25rem;
        color: var(--color-yellow-75);
        font-size: 0.7rem;
        text-transform: uppercase;
      }
      
      .coin-row td:first-child {
        grid-area: coin;
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
      }
      
      .coin-row td:first-child:before {
        display: none;
      }
      
      .coin-row td:nth-child(2) {
        grid-area: signal-strategy;
        display: inline-block;
        width: 50%;
        float: left;
      }
      
      .coin-row td:nth-child(3) {
        grid-area: signal-strategy;
        display: inline-block;
        width: 50%;
        float: right;
      }
      
      .coin-row td:nth-child(4) {
        grid-area: action;
        clear: both;
      }
      
      .details-row td {
        display: block !important;
      }
      
      /* Shrink nav buttons on mobile */
      .grid[style*="grid-template-columns"] {
        grid-template-columns: 1fr 1fr 1fr auto !important;
      }
      
      .btn-base {
        padding: 0.35rem 0.25rem !important;
        font-size: 0.6rem !important;
        min-width: auto !important;
      }
      
      #refreshBtn svg {
        width: 16px !important;
        height: 16px !important;
      }
    }
    
    /* Table container responsive */
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    /* Timeframe grid */
    .tf-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
      width: 100%;
      box-sizing: border-box;
    }
    
    @media (min-width: 1024px) {
      .tf-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    .tf-grid > * {
      min-width: 0;
      max-width: 100%;
      box-sizing: border-box;
    }
  </style>
</head>
<body class="min-h-screen">
  
  <!-- Particle Background -->
  <div id="particles-js"></div>
  
  <!-- Header -->
  <header class="header-edittrax">
    <div class="max-w-6xl mx-auto px-4 py-3">
      <div class="flex flex-col items-center gap-3 w-full">
        <div class="logo-container flex items-center gap-3">
          <img src="/logos/load.gif" alt="Loading Animation" style="width: 140px; height: auto;">
          <img src="/logos/et_horizontal.png" alt="EditTrades Logo" class="logo-img">
        </div>
        <div class="grid gap-2 w-full" style="grid-template-columns: 1fr 1fr 1fr auto;">
          <a href="/strategy.html" class="btn-base btn-secondary px-2 py-2 text-xs sm:text-sm rounded text-center whitespace-nowrap">
            Proof of Strategy
          </a>
          <a href="/scanner.html" class="btn-base btn-secondary px-2 py-2 text-xs sm:text-sm rounded text-center whitespace-nowrap">
            SCAN MORE COINS
          </a>
          <button 
            id="copyAllBtn" 
            onclick="copyAllCoins()"
            class="btn-base btn-primary px-2 py-2 text-xs sm:text-sm rounded text-center whitespace-nowrap"
          >
            COPY GPT
          </button>
          <button 
            id="refreshBtn" 
            onclick="scanMajorCoins()"
            class="btn-base btn-secondary px-2 py-2 text-xs sm:text-sm rounded whitespace-nowrap"
            style="display: inline-flex; align-items: center; justify-content: center; width: auto; min-width: auto;"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto px-4 py-4" style="width: 100%; box-sizing: border-box; overflow-x: hidden;">

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-12">
      <div class="inline-block w-8 h-8 border-2 border-t-transparent rounded-full animate-spin mb-4" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
      <p style="color: var(--text-secondary);">Loading BTC, ETH & SOL...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden card rounded p-4 mb-4 border-red-600">
      <h3 class="font-bold mb-2 text-red-400">Error</h3>
      <p id="errorMessage" class="text-sm" style="color: var(--text-secondary);"></p>
      <button onclick="scanMajorCoins()" class="mt-3 btn-primary px-4 py-2 text-sm rounded">
        Retry
      </button>
    </div>

    <!-- Results Container -->
    <div id="resultsContainer" class="hidden">
      
      <!-- Opportunities Table -->
      <div class="card-edittrax rounded-lg overflow-hidden mb-4">
        <div class="table-container">
          <table class="table-edittrax">
            <thead style="background-color: var(--color-yellow-75);">
              <tr>
                <th class="px-2 py-2" style="color: black;">COIN</th>
                <th class="px-2 py-2" style="color: black;">SIGNAL</th>
                <th class="px-2 py-2" style="color: black;">STRATEGY</th>
                <th class="px-2 py-2" style="color: black;">ACTION</th>
              </tr>
            </thead>
            <tbody id="opportunitiesTable">
              <!-- Rows will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>

      </div>

  </main>

  <script>
    let scanResults = {};
    
    // Strategy states for each symbol (default: index 0 = 4-Hour)
    const strategyStates = {
      'BTCUSDT': 0,
      'ETHUSDT': 0,
      'SOLUSDT': 0
    };
    
    const strategyOptions = ['4h', 'Swing', 'Scalp'];
    
    // Cycle through strategy states
    function cycleStrategy(symbol) {
      const currentIndex = strategyStates[symbol];
      const nextIndex = (currentIndex + 1) % strategyOptions.length;
      strategyStates[symbol] = nextIndex;
      
      // Update indicator appearance
      updateStrategyIndicators(symbol);
      
      // Update signal text if NO TRADE
      updateSignalText(symbol);
    }
    
    // Update signal text based on current strategy
    function updateSignalText(symbol) {
      const data = scanResults[symbol];
      if (!data) return;
      
      const signal = data.tradeSignal;
      const hasValidTrade = signal && signal.valid;
      
      // Only update if NO TRADE
      if (!hasValidTrade) {
        const currentStrategyIndex = strategyStates[symbol] || 0;
        const currentStrategy = strategyOptions[currentStrategyIndex];
        const strategyNames = {
          '4h': '4 HOUR',
          'Swing': 'SWING',
          'Scalp': 'SCALP'
        };
        const strategyName = strategyNames[currentStrategy] || '4 HOUR';
        
        // Calculate readiness
        const readiness = calculateSignalReadiness(data);
        
        // Show readiness only if on 4h strategy
        const showReadiness = currentStrategy === '4h';
        const readinessHtml = showReadiness ? 
          `<div class="text-xs ${readiness.class}" style="font-size: 0.65rem; white-space: nowrap;">${readiness.text}</div>` : 
          `<div class="text-xs status-neutral">-</div>`;
        
        const signalElement = document.getElementById(`signal-${symbol}`);
        if (signalElement) {
          signalElement.innerHTML = `
            <div class="status-neutral" style="font-size: 0.65rem; white-space: nowrap;">NO ${strategyName}</div>
            ${readinessHtml}
          `;
        }
      }
    }
    
    // Update strategy indicator appearance
    function updateStrategyIndicators(symbol) {
      const activeIndex = strategyStates[symbol];
      
      // Update each indicator
      strategyOptions.forEach((option, index) => {
        const indicator = document.getElementById(`indicator-${symbol}-${index}`);
        if (!indicator) return;
        
        if (index === activeIndex) {
          // ON state: yellow-75 text
          indicator.style.color = 'var(--color-yellow-75)';
          indicator.style.borderColor = 'var(--color-yellow-75)';
        } else {
          // OFF state: grey text, yellow-75 border
          indicator.style.color = '#6b7280';
          indicator.style.borderColor = 'var(--color-yellow-75)';
        }
      });
    }

    // Auto-run scan on page load
    window.addEventListener('DOMContentLoaded', () => {
      scanMajorCoins();
    });

    // Main scan function
    async function scanMajorCoins() {
      const symbols = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT'];
      
      // Show loading
      document.getElementById('loadingState').classList.remove('hidden');
      document.getElementById('resultsContainer').classList.add('hidden');
      document.getElementById('errorState').classList.add('hidden');
      
      try {
        scanResults = {};
        
        // Fetch all coins in parallel with expanded timeframes
        const promises = symbols.map(symbol => 
          fetch(`/api/analyze/${symbol}?intervals=1M,1w,1d,4h,1h,15m,5m,1m`)
            .then(res => {
              if (!res.ok) throw new Error(`Failed to fetch ${symbol}`);
              return res.json();
            })
            .then(data => ({ symbol, data }))
        );
        
        const results = await Promise.all(promises);
        
        // Store results
        results.forEach(({ symbol, data }) => {
          scanResults[symbol] = data;
        });
        
        // Display results
        displayResults();
        
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('resultsContainer').classList.remove('hidden');
        
      } catch (error) {
        console.error('Scan error:', error);
        showError(error.message || 'Failed to scan markets. Check your connection and try again.');
        document.getElementById('loadingState').classList.add('hidden');
      }
    }

    // Display scan results
    function displayResults() {
      const tableBody = document.getElementById('opportunitiesTable');
      tableBody.innerHTML = '';
      
      // Create row for each coin
      const symbols = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT'];
      symbols.forEach(symbol => {
        const data = scanResults[symbol];
        if (data) {
          const row = createCoinRow(symbol, data);
          const detailsRow = createDetailsRow(symbol, data);
          tableBody.appendChild(row);
          tableBody.appendChild(detailsRow);
        }
      });
    }

    // Calculate signal readiness (proximity to trade setup)
    function calculateSignalReadiness(data) {
      if (!data || !data.analysis) {
        return { score: 0, text: 'No data', class: 'status-neutral' };
      }
      
      const signal = data.tradeSignal;
      if (signal && signal.valid) {
        // Valid trade signal = 100% ready
        return { 
          score: 100, 
          text: 'READY', 
          class: signal.direction === 'long' ? 'status-long' : 'status-short'
        };
      }
      
      // Calculate proximity based on indicator alignment
      const timeframes = ['4h', '1h', '15m', '5m'];
      let aligned = 0;
      let total = 0;
      let direction = null;
      
      timeframes.forEach(tf => {
        const analysis = data.analysis[tf];
        if (analysis && analysis.indicators) {
          const trend = analysis.indicators.analysis?.trend;
          const stochCond = analysis.indicators.stochRSI?.condition;
          const pullbackState = analysis.indicators.analysis?.pullbackState;
          
          if (trend === 'UPTREND' || trend === 'DOWNTREND') {
            total += 3;
            if (!direction) direction = trend;
            
            // Count alignment factors
            if (trend === direction) aligned += 1;
            if ((direction === 'UPTREND' && (stochCond === 'OVERSOLD' || stochCond === 'BULLISH')) ||
                (direction === 'DOWNTREND' && (stochCond === 'OVERBOUGHT' || stochCond === 'BEARISH'))) {
              aligned += 1;
            }
            if (pullbackState === 'ENTRY_ZONE') aligned += 1;
          }
        }
      });
      
      if (total === 0) {
        return { score: 0, text: 'No trend', class: 'status-neutral' };
      }
      
      const proximityPct = Math.round((aligned / total) * 100);
      const awayPct = 100 - proximityPct;
      
      return {
        score: proximityPct,
        text: `${awayPct}% away`,
        class: proximityPct > 70 ? 'status-long' : proximityPct > 40 ? 'text-yellow-400' : 'status-neutral'
      };
    }

    // Create table row for coin
    function createCoinRow(symbol, data) {
      const row = document.createElement('tr');
      const signal = data.tradeSignal;
      const hasValidTrade = signal && signal.valid;
      const tradeClass = hasValidTrade ? 
        (signal.direction === 'long' ? 'has-trade-long' : 'has-trade-short') : '';
      
      row.className = `coin-row ${tradeClass}`;
      row.id = `row-${symbol}`;
      
      // Coin name - spell out full names
      const coinNames = {
        'BTCUSDT': 'Bitcoin',
        'ETHUSDT': 'Ethereum',
        'SOLUSDT': 'Solana'
      };
      const coinName = coinNames[symbol] || symbol.replace('USDT', '');
      
      // Price and change
      const price = data.currentPrice ? `$${data.currentPrice.toLocaleString()}` : 'N/A';
      const changeClass = (data.priceChange24h || 0) >= 0 ? 'status-long' : 'status-short';
      const change = data.priceChange24h ? 
        `${data.priceChange24h >= 0 ? '+' : ''}${data.priceChange24h.toFixed(2)}%` : 'N/A';
      
      // Get current strategy for this symbol
      const currentStrategyIndex = strategyStates[symbol] || 0;
      const currentStrategy = strategyOptions[currentStrategyIndex];
      const strategyNames = {
        '4h': '4 HOUR',
        'Swing': 'SWING',
        'Scalp': 'SCALP'
      };
      const strategyName = strategyNames[currentStrategy] || '4 HOUR';
      
      // Signal readiness
      const readiness = calculateSignalReadiness(data);
      
      // Signal with confidence
      let signalHtml;
      if (hasValidTrade) {
        const dirClass = signal.direction === 'long' ? 'status-long' : 'status-short';
        const confidence = (signal.confidence * 100).toFixed(0);
        signalHtml = `
          <div id="signal-${symbol}">
            <div class="${dirClass}" style="font-size: 0.65rem; white-space: nowrap;">${signal.direction.toUpperCase()}</div>
            <div class="text-xs ${dirClass}">${confidence}%</div>
          </div>
        `;
      } else {
        // Show readiness only if on 4h strategy (since that's what we're analyzing)
        const showReadiness = currentStrategy === '4h';
        const readinessHtml = showReadiness ? 
          `<div class="text-xs ${readiness.class}" style="font-size: 0.65rem; white-space: nowrap;">${readiness.text}</div>` : 
          `<div class="text-xs status-neutral">-</div>`;
        
        signalHtml = `
          <div id="signal-${symbol}" data-symbol="${symbol}">
            <div class="status-neutral" style="font-size: 0.65rem; white-space: nowrap;">NO ${strategyName}</div>
            ${readinessHtml}
          </div>
        `;
      }
      
      row.innerHTML = `
        <td class="px-2 py-3" data-label="">
          <div class="text-lg" style="color: var(--color-yellow-75);">${coinName}</div>
        </td>
        <td class="px-2 py-3" data-label="Signal:">
          ${signalHtml}
        </td>
        <td class="px-2 py-3" data-label="Strategy:">
          <div class="flex" style="gap: 0;">
            <button 
              onclick="cycleStrategy('${symbol}')"
              class="px-3 py-1 text-xs font-mathias font-bold"
              style="background-color: var(--color-yellow-75); color: black; border: 2px solid var(--color-yellow-75); border-radius: var(--radius-md) 0 0 var(--radius-md); transition: all 0.3s; white-space: nowrap; min-width: 70px;"
            >
              EditTrades
            </button>
            <div 
              id="indicator-${symbol}-0"
              class="px-3 py-1 text-xs font-mathias font-bold"
              style="background-color: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); border-left: none; transition: all 0.3s; white-space: nowrap; display: flex; align-items: center; justify-content: center; min-width: 50px;"
            >
              4h
            </div>
            <div 
              id="indicator-${symbol}-1"
              class="px-3 py-1 text-xs font-mathias font-bold"
              style="background-color: transparent; color: #6b7280; border: 2px solid var(--color-yellow-75); border-left: none; transition: all 0.3s; white-space: nowrap; display: flex; align-items: center; justify-content: center; min-width: 50px;"
            >
              Swing
              </div>
            <div 
              id="indicator-${symbol}-2"
              class="px-3 py-1 text-xs font-mathias font-bold"
              style="background-color: transparent; color: #6b7280; border: 2px solid var(--color-yellow-75); border-left: none; border-radius: 0 var(--radius-md) var(--radius-md) 0; transition: all 0.3s; white-space: nowrap; display: flex; align-items: center; justify-content: center; min-width: 50px;"
            >
              Scalp
          </div>
          </div>
        </td>
        <td class="px-2 py-3" data-label="Action:">
          <div class="flex gap-1">
            <button 
              onclick="toggleDetails('${symbol}')"
              class="px-3 py-1 text-xs font-mathias font-bold"
              style="background-color: var(--color-yellow-75); color: black; border: 2px solid var(--color-yellow-75); border-radius: var(--radius-md); transition: all 0.3s;"
              id="toggle-${symbol}"
            >
              Details
            </button>
            <button 
              onclick="copyCoinView('${symbol}')"
              class="px-3 py-1 text-xs font-mathias font-bold"
              style="background-color: var(--color-yellow-75); color: black; border: 2px solid var(--color-yellow-75); border-radius: var(--radius-md); transition: all 0.3s;"
            >
              Copy
            </button>
          </div>
        </td>
      `;
      
      return row;
    }

    // Detect Stoch RSI curl direction
    function detectStochCurl(stochRSI) {
      if (!stochRSI || stochRSI.k === null || stochRSI.d === null) {
        return { direction: 'flat', text: '→ Flat', color: 'status-neutral' };
      }
      
      const diff = stochRSI.k - stochRSI.d;
      
      if (diff > 5) {
        return { direction: 'up', text: '↑ Curling Up', color: 'status-long' };
      } else if (diff < -5) {
        return { direction: 'down', text: '↓ Curling Down', color: 'status-short' };
      } else {
        return { direction: 'flat', text: '→ Flat', color: 'status-neutral' };
      }
    }
    
    // Get Stoch range/zone
    function getStochZone(k) {
      if (k === null || k === undefined) return 'UNKNOWN';
      if (k >= 80) return 'OVERBOUGHT';
      if (k <= 20) return 'OVERSOLD';
      if (k >= 50) return 'BULLISH ZONE';
      return 'BEARISH ZONE';
    }

    // Create details row with full timeframe breakdown
    function createDetailsRow(symbol, data) {
      const detailsRow = document.createElement('tr');
      detailsRow.className = 'details-row';
      detailsRow.id = `details-${symbol}`;
      
      // Create detailed timeframe cards - ALL TIMEFRAMES (1m first, 1 Month last)
      const timeframes = ['1m', '5m', '15m', '1h', '4h', '1d', '1w', '1M'];
      const tfCards = timeframes.map(tf => {
        const analysis = data.analysis?.[tf];
        if (!analysis || analysis.error || !analysis.indicators) {
          return `<div class="tf-card"><p class="text-sm font-bold mb-2">${tf.toUpperCase()}</p><p class="text-xs" style="color: var(--text-secondary);">No data</p></div>`;
        }
        
        const ind = analysis.indicators;
        const trend = ind.analysis?.trend || 'UNKNOWN';
        const trendClass = trend === 'UPTREND' ? 'uptrend' : 
                          trend === 'DOWNTREND' ? 'downtrend' : 'flat';
        const trendBadge = trend === 'UPTREND' ? 'UPTREND' : 
                          trend === 'DOWNTREND' ? 'DOWNTREND' : 'FLAT';
        
        // Stoch curl detection
        const stochCurl = detectStochCurl(ind.stochRSI);
        const stochZone = getStochZone(ind.stochRSI?.k);
        
        // Display name for timeframe (spell out Month)
        const tfDisplay = tf === '1M' ? '1 MONTH' : tf.toUpperCase();
        
        return `
          <div class="tf-card ${trendClass}">
            <div class="flex items-center justify-between mb-3">
              <p class="text-sm font-bold">${tfDisplay}</p>
              <span class="text-xs px-2 py-0.5 rounded ${trend === 'UPTREND' ? 'status-long' : trend === 'DOWNTREND' ? 'status-short' : 'status-neutral'}" style="background-color: var(--bg-tertiary);">${trendBadge}</span>
          </div>

            <div class="space-y-2 text-xs">
                <div class="flex justify-between">
                <span style="color: var(--text-secondary);">Current Price</span>
                <span class="font-bold">${ind.price?.current ? '$' + ind.price.current.toLocaleString() : 'N/A'}</span>
                </div>
              
                <div class="flex justify-between">
                <span style="color: var(--text-secondary);">21 EMA</span>
                <span class="font-bold">${ind.ema?.ema21 ? '$' + ind.ema.ema21.toLocaleString() : 'N/A'}</span>
                </div>
              
                  <div class="flex justify-between">
                <span style="color: var(--text-secondary);">200 EMA</span>
                <span class="font-bold">${ind.ema?.ema200 ? '$' + ind.ema.ema200.toLocaleString() : 'N/A'}</span>
                  </div>
              
              <div class="border-t pt-2" style="border-color: var(--border);">
                <div class="flex justify-between mb-1">
                  <span style="color: var(--text-secondary);">Stoch RSI</span>
                  <span class="text-xs px-1 py-0.5 rounded ${getStochColor(ind.stochRSI?.condition)}" style="background-color: var(--bg-tertiary);">${ind.stochRSI?.condition || 'N/A'}</span>
              </div>
                <div class="flex justify-between mb-1">
                  <span class="text-xs" style="color: var(--text-secondary);">${stochZone}</span>
                  <span class="${stochCurl.color} font-medium">${stochCurl.text}</span>
            </div>
                <div class="flex justify-between text-xs" style="color: var(--text-secondary);">
                  <span>%K: ${ind.stochRSI?.k ? ind.stochRSI.k.toFixed(0) : 'N/A'}</span>
                  <span>%D: ${ind.stochRSI?.d ? ind.stochRSI.d.toFixed(0) : 'N/A'}</span>
                </div>
                </div>
              
              <div class="border-t pt-2" style="border-color: var(--border);">
                <div class="flex justify-between mb-1">
                  <span style="color: var(--text-secondary);">Pullback State</span>
                  <span class="text-xs px-1 py-0.5 rounded ${getPullbackColor(ind.analysis?.pullbackState)}" style="background-color: var(--bg-tertiary);">${ind.analysis?.pullbackState || 'N/A'}</span>
                </div>
                ${ind.analysis?.distanceFrom21EMA !== null && ind.analysis?.distanceFrom21EMA !== undefined ? `
                  <div class="text-xs" style="color: var(--text-secondary);">
                    Distance from 21 EMA: ${ind.analysis.distanceFrom21EMA.toFixed(2)}%
              </div>
                ` : ''}
            </div>

              ${analysis.structure?.swingHigh || analysis.structure?.swingLow ? `
                <div class="border-t pt-2" style="border-color: var(--border);">
                  ${analysis.structure.swingHigh ? `
                  <div class="flex justify-between">
                      <span style="color: var(--text-secondary);">Swing High</span>
                      <span class="font-bold">$${analysis.structure.swingHigh.toLocaleString()}</span>
                  </div>
                ` : ''}
                  ${analysis.structure.swingLow ? `
                  <div class="flex justify-between">
                      <span style="color: var(--text-secondary);">Swing Low</span>
                      <span class="font-bold">$${analysis.structure.swingLow.toLocaleString()}</span>
                  </div>
                ` : ''}
                  </div>
                ` : ''}
              </div>
            </div>
        `;
      }).join('');
      
      detailsRow.innerHTML = `
        <td colspan="4">
          <div class="details-content-wrapper">
            <div class="tf-grid">
              ${tfCards}
          </div>
        </div>
        </td>
      `;
      
      return detailsRow;
    }

    // Helper functions for styling
    function getStochColor(condition) {
      const colors = {
        'OVERBOUGHT': 'status-short',
        'OVERSOLD': 'status-long',
        'BULLISH': 'status-long',
        'BEARISH': 'status-short',
        'NEUTRAL': 'status-neutral'
      };
      return colors[condition] || 'status-neutral';
    }

    function getPullbackColor(state) {
      const colors = {
        'ENTRY_ZONE': 'status-long',
        'OVEREXTENDED': 'style="color: #f59e0b;"',
        'RETRACING': 'style="color: #3b82f6;"',
        'UNKNOWN': 'status-neutral'
      };
      return colors[state] || 'status-neutral';
    }

    // Toggle details row
    function toggleDetails(symbol) {
      const detailsRow = document.getElementById(`details-${symbol}`);
      const button = document.getElementById(`toggle-${symbol}`);
      
      if (detailsRow.classList.contains('expanded')) {
        detailsRow.classList.remove('expanded');
        button.textContent = 'Show';
      } else {
        detailsRow.classList.add('expanded');
        button.textContent = 'Hide';
      }
    }


    // Copy single coin view
    function copyCoinView(symbol) {
      const data = scanResults[symbol];
      if (!data) {
        alert('No data available for ' + symbol);
        return;
      }
      
      const dashboardView = createDashboardView(data);
      const jsonString = JSON.stringify(dashboardView, null, 2);
      
      navigator.clipboard.writeText(jsonString).then(() => {
        showCopySuccess(`${symbol.replace('USDT', '')} copied!`);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy');
      });
    }

    // Copy all coins
    function copyAllCoins() {
      const allViews = {};
      
      for (const [symbol, data] of Object.entries(scanResults)) {
        allViews[symbol] = createDashboardView(data);
      }
      
      const jsonString = JSON.stringify(allViews, null, 2);
      
      navigator.clipboard.writeText(jsonString).then(() => {
        showCopySuccess('All coins copied!');
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy');
      });
    }

    // Create compact dashboard view
    function createDashboardView(data) {
      const view = {
        symbol: data.symbol,
        price: data.currentPrice,
        change24h: data.priceChange24h,
        signal: null,
        timeframes: {}
      };
      
      // Signal
      if (data.tradeSignal) {
        view.signal = {
          valid: data.tradeSignal.valid,
          direction: data.tradeSignal.direction || 'NO_TRADE',
          confidence: data.tradeSignal.confidence ? 
            parseFloat((data.tradeSignal.confidence * 100).toFixed(0)) : 0,
          reason: data.tradeSignal.reason_summary || data.tradeSignal.reason
        };
        
        if (data.tradeSignal.valid && data.tradeSignal.entry_zone) {
          view.signal.entryZone = {
            min: data.tradeSignal.entry_zone.min,
            max: data.tradeSignal.entry_zone.max
          };
          view.signal.stopLoss = data.tradeSignal.stop_loss;
          view.signal.targets = {
            tp1: data.tradeSignal.targets?.[0],
            tp2: data.tradeSignal.targets?.[1]
          };
        }
      }
      
      // Timeframes
      if (data.analysis) {
        for (const [interval, analysis] of Object.entries(data.analysis)) {
          if (analysis.error || !analysis.indicators) {
            view.timeframes[interval] = { error: analysis.error || 'No data' };
            continue;
          }
          
          const ind = analysis.indicators;
          view.timeframes[interval] = {
            trend: ind.analysis?.trend || 'UNKNOWN',
            ema21: ind.ema?.ema21 ? parseFloat(ind.ema.ema21.toFixed(2)) : null,
            ema200: ind.ema?.ema200 ? parseFloat(ind.ema.ema200.toFixed(2)) : null,
            stoch: {
              k: ind.stochRSI?.k ? parseFloat(ind.stochRSI.k.toFixed(1)) : null,
              d: ind.stochRSI?.d ? parseFloat(ind.stochRSI.d.toFixed(1)) : null,
              condition: ind.stochRSI?.condition || 'UNKNOWN'
            },
            pullback: {
              state: ind.analysis?.pullbackState || 'UNKNOWN',
              distanceFrom21EMA: ind.analysis?.distanceFrom21EMA ? 
                parseFloat(ind.analysis.distanceFrom21EMA.toFixed(2)) : null
            },
            swingHigh: analysis.structure?.swingHigh ? 
              parseFloat(analysis.structure.swingHigh.toFixed(2)) : null,
            swingLow: analysis.structure?.swingLow ? 
              parseFloat(analysis.structure.swingLow.toFixed(2)) : null
          };
        }
      }
      
      view.timestamp = data.timestamp;
      return view;
    }

    // Show copy success toast
    function showCopySuccess(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 1rem;
        right: 1rem;
        background-color: var(--text-primary);
        color: var(--bg-primary);
        padding: 0.75rem 1rem;
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        z-index: 1000;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 2000);
    }

    // Show error
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorState').classList.remove('hidden');
    }
  </script>

  <!-- Particles.js Library -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <script>
    // Initialize particle system
    particlesJS('particles-js', {
      particles: {
        number: {
          value: 100,
          density: {
            enable: true,
            value_area: 800
          }
        },
        color: {
          value: '#ffffff'
        },
        shape: {
          type: 'circle'
        },
        opacity: {
          value: 0.5,
          random: true,
          anim: {
            enable: true,
            speed: 1,
            opacity_min: 0.1,
            sync: false
          }
        },
        size: {
          value: 2,
          random: true,
          anim: {
            enable: false
          }
        },
        line_linked: {
          enable: false
        },
        move: {
          enable: true,
          speed: 0.5,
          direction: 'none',
          random: true,
          straight: false,
          out_mode: 'out',
          bounce: false
        }
      },
      interactivity: {
        detect_on: 'canvas',
        events: {
          onhover: {
            enable: false
          },
          onclick: {
            enable: false
          },
          resize: true
        }
      },
      retina_detect: true
    });
  </script>

</body>
</html>
