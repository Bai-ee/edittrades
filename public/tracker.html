<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trade Tracker - EditTrades</title>
  
  <!-- External Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Styles -->
  <link rel="stylesheet" href="/edittrax-styles.css">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  
  <style>
    /* Font Strategy: Mathias for labels/headings, System font for content */
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-mathias);
    }
    
    p, ul, li, .card p, .card ul, .card li, input, select, textarea {
      font-family: var(--font-system);
    }
    
    /* Strong tags in content should use Mathias for emphasis */
    li strong, p strong {
      font-family: var(--font-mathias);
    }

    body {
      background-color: #000000;
      position: relative;
      min-height: 100vh;
    }
    
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: 0;
    }
    
    header, main {
      position: relative;
      z-index: 1;
    }
    
    .form-group {
      margin-bottom: 1rem;
      width: 100%;
      box-sizing: border-box;
      overflow: hidden;
    }
    
    .grid {
      width: 100%;
      box-sizing: border-box;
    }
    
    .form-label {
      display: block;
      font-family: var(--font-mathias);
      font-size: 0.875rem;
      font-weight: bold;
      color: var(--color-yellow-75);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 0.75rem;
      background-color: rgba(0, 0, 0, 0.6);
      border: 2px solid var(--color-yellow-75);
      border-radius: 0.5rem;
      color: var(--color-yellow-75);
      font-size: 1rem;
      font-family: var(--font-system);
      box-sizing: border-box;
      max-width: 100%;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--color-yellow-75);
      box-shadow: 0 0 0 3px rgba(230, 233, 224, 0.1);
    }
    
    .details-row {
      display: none;
    }
    
    .details-row.expanded {
      display: table-row;
    }
    
    /* Table row styling */
    .coin-row {
      position: relative;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      background-color: transparent;
    }
    
    /* Static glow background for LONG trades */
    .coin-row.has-trade-long {
      background: radial-gradient(
        ellipse at 0% 50%,
        rgba(34, 197, 94, 0.2) 0%,
        rgba(34, 197, 94, 0.12) 30%,
        rgba(34, 197, 94, 0.06) 60%,
        rgba(34, 197, 94, 0.02) 100%
      );
    }
    
    /* Static glow background for SHORT trades */
    .coin-row.has-trade-short {
      background: radial-gradient(
        ellipse at 0% 50%,
        rgba(239, 68, 68, 0.2) 0%,
        rgba(239, 68, 68, 0.12) 30%,
        rgba(239, 68, 68, 0.06) 60%,
        rgba(239, 68, 68, 0.02) 100%
      );
    }
    
    /* All table cells */
    .coin-row > td {
      background-color: transparent;
      position: relative;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* Desktop column widths */
    @media (min-width: 769px) {
      .table-edittrax th,
      .table-edittrax td {
        padding: var(--spacing-2) var(--spacing-2);
      }
      
      /* Set fixed column widths */
      .table-edittrax thead th:nth-child(1),
      .table-edittrax tbody td:nth-child(1) { 
        width: 150px; 
        min-width: 150px;
        max-width: 150px;
        white-space: nowrap;
        text-align: center;
      } /* TRADE */
      
      .table-edittrax thead th:nth-child(2),
      .table-edittrax tbody td:nth-child(2) { 
        width: 100px; 
        min-width: 100px;
        max-width: 100px;
        white-space: nowrap;
        text-align: left;
        padding-left: 1rem;
      } /* P&L */
      
      .table-edittrax thead th:nth-child(3),
      .table-edittrax tbody td:nth-child(3) { 
        width: auto;
        text-align: left;
        padding-left: 1rem;
      } /* STATUS - fills remaining space */
      
      .table-edittrax thead th:nth-child(4),
      .table-edittrax tbody td:nth-child(4) { 
        width: 120px;
        min-width: 120px;
        max-width: 120px;
        white-space: nowrap;
        text-align: center;
      } /* DETAILS */
      
      .coin-row {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
    }
    
    /* Mobile Styles */
    @media (max-width: 768px) {
      .max-w-6xl.mx-auto.pt-3 {
        padding-left: 5px !important;
        padding-right: 5px !important;
      }
      
      main.max-w-6xl.mx-auto {
        padding-left: 5px !important;
        padding-right: 5px !important;
      }
      
      #tradesContainer {
        padding-left: 5px !important;
        padding-right: 5px !important;
      }
      
      .header-edittrax > div > div[style*="position: absolute"][style*="left: 0"] {
        left: calc(5px + 8px) !important;
        font-size: 0.6rem !important;
      }
      
      .header-edittrax > div > div[style*="position: absolute"][style*="right: 0"] {
        right: 5px !important;
        font-size: 0.6rem !important;
      }
      
      /* Hide table header on mobile */
      .table-edittrax thead {
        display: none;
      }
      
      /* Mobile table adjustments */
      .coin-row {
        display: block !important;
        padding: 0 0.5rem 1rem 0.5rem;
        border-bottom: 2px solid var(--color-yellow-75);
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }
      
      .table-edittrax tbody {
        display: block !important;
      }
      
      .table-edittrax tbody tr.coin-row {
        display: block !important;
      }
      
      /* Keep details row hidden unless expanded */
      .table-edittrax tbody tr.details-row {
        display: none !important;
      }
      
      .table-edittrax tbody tr.details-row.expanded {
        display: block !important;
      }
      
      .table-edittrax tbody tr.details-row.expanded td {
        display: block !important;
      }
      
      /* Create flex container for rows */
      .coin-row::after {
        content: "";
        display: table;
        clear: both;
      }
      
      .coin-row td {
        padding: 0.5rem 0 !important;
        border: none;
        text-align: left !important;
        max-width: 100%;
        box-sizing: border-box;
        display: block;
      }
      
      .coin-row td:before {
        content: attr(data-label);
        font-weight: bold;
        display: block;
        margin-bottom: 0.25rem;
        color: var(--color-yellow-75);
        font-family: var(--font-mathias);
        font-size: 0.75rem;
      }
      
      /* Trade name and P&L on same row */
      .coin-row td:first-child,
      .coin-row td:nth-child(2) {
        display: inline-block;
        vertical-align: top;
      }
      
      .coin-row td:first-child {
        width: auto;
        max-width: 50%;
        font-size: 1.25rem;
        padding-right: 0.5rem !important;
        padding-left: 0 !important;
        text-align: left !important;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        box-sizing: border-box;
      }
      
      .coin-row td:first-child > div {
        align-items: flex-start !important;
        justify-content: flex-start !important;
      }
      
      .coin-row td:first-child > div > div {
        text-align: left !important;
        font-size: 1.25rem !important;
      }
      
      .coin-row td:first-child:before {
        display: none;
      }
      
      .coin-row td:nth-child(2) {
        width: auto;
        float: right;
        text-align: right;
        padding-left: 0.5rem !important;
      }
      
      .coin-row td:nth-child(2):before {
        display: none;
      }
      
      /* Make P&L text larger on mobile to match signal size on homepage */
      .coin-row td:nth-child(2) > div {
        font-size: 1.25rem !important;
        text-align: right !important;
      }
      
      /* Status on its own row */
      .coin-row td:nth-child(3) {
        display: block;
        clear: both;
        width: 100%;
      }
      
      /* Details button on its own row */
      .coin-row td:nth-child(4) {
        display: block !important;
        width: 100% !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        max-width: 100% !important;
      }
      
      .coin-row td:nth-child(4):before {
        display: none !important;
      }
      
      /* Make buttons full width on mobile */
      .coin-row .details-button-cell {
        display: block !important;
        width: 100% !important;
      }
      
      .coin-row .details-button,
      .coin-row td:nth-child(4) button,
      .coin-row .details-button-cell button {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        display: block !important;
      }
      
      /* Mobile modal adjustments */
      #addTradeModal {
        padding: 0.75rem !important;
      }
      
      #addTradeModal > div {
        padding: 1rem !important;
        max-width: 100% !important;
        width: 100% !important;
        margin: 0 !important;
      }
    }
  </style>
</head>
<body>
  <!-- Particles Background -->
  <div id="particles-js"></div>
  
  <!-- Color Bar -->
  <img 
    src="/logos/color_bar.png" 
    alt="Color Bar" 
    style="position: fixed; top: 0; left: 0; width: 100%; height: 5px; max-height: 5px; z-index: 9999; pointer-events: none; display: block; object-fit: cover;"
  >

  <!-- Header -->
  <header class="header-edittrax text-white" style="overflow: visible; position: relative;">
    <div class="max-w-6xl mx-auto pt-3" style="width: 100%; box-sizing: border-box; padding-left: 1rem; padding-right: 1rem; position: relative;">
      
      <!-- Top Left: Timers -->
      <div style="position: absolute; top: 25px; left: 0; display: flex; flex-direction: column; gap: 6px; z-index: 50; font-family: var(--font-mathias); color: var(--color-yellow-75); font-size: 0.75rem; font-weight: bold;">
        <!-- 1M Candle Timer -->
        <div id="1m-timer-container" style="display: flex; align-items: center; gap: 8px;">
          <span>1M</span>
          <div style="width: 50px; height: 3px; background-color: rgba(230, 233, 224, 0.2); border-radius: 2px; overflow: hidden;">
            <div id="candle-timer-bar" style="width: 100%; height: 100%; background-color: var(--color-yellow-75); transition: width 0.5s linear;"></div>
          </div>
        </div>
        <!-- 4H Candle Timer -->
        <div id="4h-timer-container" style="display: flex; align-items: center; gap: 8px;">
          <span>4H</span>
          <div style="width: 50px; height: 3px; background-color: rgba(230, 233, 224, 0.2); border-radius: 2px; overflow: hidden;">
            <div id="4h-timer-bar" style="width: 100%; height: 100%; background-color: var(--color-yellow-75); transition: width 0.5s linear;"></div>
          </div>
        </div>
      </div>
      
      <!-- Top Right Actions -->
      <div style="position: absolute; top: 25px; right: 0; display: flex; flex-direction: column; gap: 17px; align-items: flex-end; z-index: 50; font-family: var(--font-mathias); font-size: 0.75rem;">
        <!-- Home -->
        <a 
          href="/"
          style="display: inline-flex; align-items: center; gap: 8px; background: transparent; border: none; color: var(--color-yellow-75); cursor: pointer; padding: 4px 8px; font-family: var(--font-mathias); font-size: 0.75rem; text-decoration: none;"
          title="Back to Home"
        >
          <span style="font-weight: bold;">‚Üê HOME</span>
        </a>
      </div>
      
      <div class="flex flex-col items-center gap-3 w-full">
        <div class="logo-container flex flex-col items-center gap-2">
          <img src="/logos/load.gif" alt="Loading Animation" style="width: 140px; height: auto;">
          <img src="/logos/et_horizontal.png" alt="EditTrades Logo" class="logo-img">
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto pb-4" style="width: 100%; box-sizing: border-box;overflow: visible; position: relative;">
    
    <!-- Add New Trade Button -->
    <div style="padding: 1rem; display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
      <button 
        onclick="document.getElementById('addTradeModal').style.display='flex'"
        class="btn-base btn-secondary text-xs sm:text-sm rounded text-center whitespace-nowrap"
        style="padding: 0.5rem 1rem; transition: all 0.3s ease;"
      >
        + ADD NEW TRADE
      </button>
      <button 
        onclick="refreshTrades()"
        class="btn-base btn-secondary text-xs sm:text-sm rounded text-center whitespace-nowrap"
        style="padding: 0.5rem 1rem; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px;"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
        </svg>
        <span>REFRESH</span>
      </button>
    </div>
    
    <!-- Trades Table (Exact copy of homepage table structure) -->
    <div id="tradesContainer" style="padding-left: 1rem; padding-right: 1rem;">
      <div class="card-edittrax rounded-lg mb-4" style="overflow: hidden; border: 2px solid var(--color-yellow-75); max-width: 100%; box-sizing: border-box;">
        <div class="table-container" style="width: 100%; overflow-x: auto; margin: 0; padding: 0; border: none; box-sizing: border-box;">
          <table class="table-edittrax" style="border: none; margin: 0; border-collapse: collapse; width: 100%; max-width: 100%; table-layout: fixed; box-sizing: border-box;">
            <thead style="background-color: var(--color-yellow-75); border: none; border-left: none; border-right: none;">
              <tr style="border: none; border-left: none; border-right: none;">
                <th class="px-2" style="padding-top: 0.9rem; padding-bottom: 0.9rem; color: black; text-align: center; border: none; border-left: none; width: 150px; min-width: 150px; max-width: 150px;">TRADE</th>
                <th class="px-2" style="padding-top: 0.9rem; padding-bottom: 0.9rem; color: black; text-align: left; width: 100px; min-width: 100px; max-width: 100px;">P&L</th>
                <th class="px-2" style="padding-top: 0.9rem; padding-bottom: 0.9rem; color: black; text-align: left;">STATUS</th>
                <th class="px-2" style="padding-top: 0.9rem; padding-bottom: 0.9rem; color: black; width: 120px; min-width: 120px; max-width: 120px;"></th>
              </tr>
            </thead>
            <tbody id="tradesTable">
              <!-- Trade rows will be populated here -->
            </tbody>
          </table>
        </div>
        
        <!-- Legend -->
        <div style="padding: 0.75rem 1.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
          <a 
            href="/strategy.html"
            style="display: inline-flex; align-items: center; gap: 8px; background: transparent; border: none; color: var(--color-yellow-75); cursor: pointer; padding: 4px 8px; font-family: var(--font-mathias); font-size: 0.75rem; text-decoration: none;"
            title="Proof of Strategy"
          >
            <span style="font-weight: bold;">PROOF OF STRATEGY</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Add Trade Modal -->
  <div id="addTradeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.95); z-index: 10000; align-items: center; justify-content: center; padding: 2rem; box-sizing: border-box; overflow-x: hidden;">
    <div class="card rounded-lg" style="max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; overflow-x: hidden; border: 2px solid var(--color-yellow-75); background-color: #000000; padding: 2rem; box-sizing: border-box;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 class="text-2xl font-bold">Add New Trade</h2>
        <button 
          onclick="document.getElementById('addTradeModal').style.display='none'"
          style="background: transparent; border: none; color: var(--color-yellow-75); font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px;"
        >
          √ó
        </button>
      </div>
      
      <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1.5rem;">
        Enter your trade details - we'll auto-calculate targets and track your P&L in real-time.
      </p>
      
      <form id="addTradeForm" style="overflow-x: hidden; width: 100%; box-sizing: border-box;">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label class="form-label">Symbol</label>
            <select id="symbol" class="form-select" required>
              <option value="BTCUSDT">Bitcoin (BTC)</option>
              <option value="ETHUSDT">Ethereum (ETH)</option>
              <option value="SOLUSDT">Solana (SOL)</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Direction</label>
            <select id="direction" class="form-select" required>
              <option value="">Select Direction</option>
              <option value="LONG">Long (Buy)</option>
              <option value="SHORT">Short (Sell)</option>
            </select>
          </div>
          
          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">Entry Price</label>
            <input type="number" id="entry" class="form-input" step="0.01" placeholder="e.g. 42000" required>
          </div>
        </div>
        
        <div id="tradePreview" style="display: none; margin-top: 1rem; padding: 1rem; background-color: rgba(255, 255, 255, 0.05); border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1);">
          <p style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.875rem; font-weight: bold; margin-bottom: 0.5rem;">AUTO-CALCULATED:</p>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; font-size: 0.875rem;">
            <div>
              <span style="color: var(--text-secondary);">Direction:</span>
              <span id="previewDirection" style="color: var(--color-yellow-75); font-weight: bold; margin-left: 0.25rem;"></span>
            </div>
            <div>
              <span style="color: var(--text-secondary);">Stop:</span>
              <span id="previewStop" style="color: #ef4444; font-weight: bold; margin-left: 0.25rem;"></span>
            </div>
            <div>
              <span style="color: var(--text-secondary);">TP1:</span>
              <span id="previewTP1" style="color: #22c55e; font-weight: bold; margin-left: 0.25rem;"></span>
            </div>
            <div>
              <span style="color: var(--text-secondary);">TP2:</span>
              <span id="previewTP2" style="color: #22c55e; font-weight: bold; margin-left: 0.25rem;"></span>
            </div>
          </div>
        </div>
        
        <div class="form-group mt-4">
          <label class="form-label">Stop Loss</label>
          <input type="number" id="stopLoss" class="form-input" step="0.01" placeholder="e.g. 41000" required>
        </div>
        
        <div class="form-group mt-4">
          <label class="form-label">Journal / Notes (Optional)</label>
          <textarea 
            id="journal" 
            class="form-input" 
            rows="4" 
            placeholder="Add your trade thesis, setup notes, or any observations..."
            style="resize: vertical; min-height: 100px;"
          ></textarea>
          <small style="color: rgba(230, 233, 224, 0.6); font-size: 0.75rem; margin-top: 0.25rem; display: block;">
            Document your reasoning, market conditions, or anything relevant to this trade.
          </small>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 0.75rem; margin-top: 1rem;">
          <button 
            type="submit" 
            class="btn-base btn-secondary px-4 py-2 text-sm rounded"
            style="width: 100%; background-color: var(--color-yellow-75); color: black; font-weight: bold; transition: all 0.3s ease;"
          >
            ADD TRADE
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBbelW2KJhS6d9XjlfeNVBmWMIRLlPJt18",
      authDomain: "edittrades-fd451.firebaseapp.com",
      projectId: "edittrades-fd451",
      storageBucket: "edittrades-fd451.firebasestorage.app",
      messagingSenderId: "19886833588",
      appId: "1:19886833588:web:321896aa22c76f5184bce1",
      measurementId: "G-0DCF1KBHMG"
    };
    
    // Initialize Firebase
    let db, storage;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      storage = firebase.storage();
      console.log('‚úÖ Firebase initialized successfully');
    } catch (error) {
      console.error('‚ùå Firebase initialization error:', error);
      console.log('‚ö†Ô∏è Falling back to localStorage');
    }
    
    // Trade storage
    let trades = [];
    let priceCache = {};
    
    console.log('üì¶ Loading trades from Firebase...');
    
    // 1-minute candle timer
    function updateCandleTimer() {
      const now = new Date();
      const seconds = now.getSeconds();
      const msIntoSecond = now.getMilliseconds();
      const percentComplete = (seconds + msIntoSecond / 1000) / 60;
      const percentRemaining = 1 - percentComplete;
      
      const bar = document.getElementById('candle-timer-bar');
      if (bar) {
        bar.style.width = `${percentRemaining * 100}%`;
      }
    }
    
    // 4-hour candle timer
    function update4HTimer() {
      const now = new Date();
      const fourHoursMs = 4 * 60 * 60 * 1000;
      const msInto4H = now.getTime() % fourHoursMs;
      const percentComplete = msInto4H / fourHoursMs;
      const percentRemaining = 1 - percentComplete;
      
      const bar = document.getElementById('4h-timer-bar');
      if (bar) {
        bar.style.width = `${percentRemaining * 100}%`;
      }
    }
    
    // Start timers
    function startCandleTimers() {
      updateCandleTimer();
      update4HTimer();
      
      setInterval(updateCandleTimer, 500);
      setInterval(update4HTimer, 1000);
    }
    
    // Auto-calculate trade parameters
    let calculatedTrade = null;
    
    async function updateTradePreview() {
      const symbol = document.getElementById('symbol').value;
      const entryInput = document.getElementById('entry').value;
      const directionInput = document.getElementById('direction').value;
      const stopLossInput = document.getElementById('stopLoss').value;
      
      console.log('üîÑ Preview update:', { symbol, entry: entryInput, direction: directionInput, stopLoss: stopLossInput });
      
      if (!entryInput || parseFloat(entryInput) <= 0 || !directionInput || !stopLossInput || parseFloat(stopLossInput) <= 0) {
        console.log('‚ö†Ô∏è Missing inputs, hiding preview');
        document.getElementById('tradePreview').style.display = 'none';
        return;
      }
      
      const entry = parseFloat(entryInput);
      const direction = directionInput;
      const stopLoss = parseFloat(stopLossInput);
      
      // Validate stop loss is on correct side
      if (direction === 'LONG' && stopLoss >= entry) {
        document.getElementById('tradePreview').style.display = 'none';
        return;
      }
      if (direction === 'SHORT' && stopLoss <= entry) {
        document.getElementById('tradePreview').style.display = 'none';
        return;
      }
      
      // Calculate risk
      const risk = Math.abs(entry - stopLoss);
      
      // Calculate targets (1R and 2R)
      const target1 = direction === 'LONG' ?
        entry + risk : // 1R above entry
        entry - risk;  // 1R below entry
      
      const target2 = direction === 'LONG' ?
        entry + (risk * 2) : // 2R above entry
        entry - (risk * 2);  // 2R below entry
      
      // Auto-detect strategy based on current timeframe analysis
      let strategy = 'SCALP'; // Default
      try {
        const response = await fetch(`/api/analyze/${symbol}?intervals=4h,1h,15m`);
        const data = await response.json();
        const signal = data.signal || data.tradeSignal;
        if (signal && signal.setupType) {
          const setupType = signal.setupType.toUpperCase();
          if (setupType.includes('4H')) strategy = '4H';
          else if (setupType.includes('SWING')) strategy = 'SWING';
          else if (setupType.includes('MICRO')) strategy = 'MICROSCALP';
          else strategy = 'SCALP';
        }
      } catch (error) {
        console.log('Could not auto-detect strategy, using default');
      }
      
      // Store calculated trade
      calculatedTrade = {
        direction,
        stopLoss,
        target1,
        target2,
        strategy,
        riskPercent: 1 // Default 1% risk
      };
      
      // Update preview
      document.getElementById('previewDirection').textContent = direction;
      document.getElementById('previewDirection').style.color = direction === 'LONG' ? '#22c55e' : '#ef4444';
      document.getElementById('previewStop').textContent = `$${stopLoss.toFixed(2)}`;
      document.getElementById('previewTP1').textContent = `$${target1.toFixed(2)}`;
      document.getElementById('previewTP2').textContent = `$${target2.toFixed(2)}`;
      document.getElementById('previewRisk').textContent = `${((risk / entry) * 100).toFixed(2)}%`;
      
      document.getElementById('tradePreview').style.display = 'block';
    }
    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', async () => {
      startCandleTimers();
      
      // Load trades from Firebase
      await loadTrades();
      
      renderTrades();
      startPriceUpdates();
      
      // Add event listeners for auto-preview
      document.getElementById('symbol').addEventListener('change', updateTradePreview);
      document.getElementById('direction').addEventListener('change', updateTradePreview);
      document.getElementById('entry').addEventListener('input', updateTradePreview);
      document.getElementById('stopLoss').addEventListener('input', updateTradePreview);
    });
    
    // Add trade form submission
    document.getElementById('addTradeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const symbol = document.getElementById('symbol').value;
      const direction = document.getElementById('direction').value;
      const entry = parseFloat(document.getElementById('entry').value);
      const stopLoss = parseFloat(document.getElementById('stopLoss').value);
      const journal = document.getElementById('journal').value || '';
      const uploadedImageUrl = document.getElementById('uploadedImageUrl')?.value || null;
      
      console.log('üìù Form submitted:', { symbol, direction, entry, stopLoss, journal, imageUrl: uploadedImageUrl });
      
      // Validate inputs
      if (!symbol || !direction || !entry || !stopLoss) {
        alert('Please fill in all required fields');
        return;
      }
      
      // Validate stop loss
      if (direction === 'LONG' && stopLoss >= entry) {
        alert('Stop loss must be below entry price for LONG trades');
        return;
      }
      if (direction === 'SHORT' && stopLoss <= entry) {
        alert('Stop loss must be above entry price for SHORT trades');
        return;
      }
      
      // Calculate targets
      const risk = Math.abs(entry - stopLoss);
      const target1 = direction === 'LONG' ? entry + risk : entry - risk;
      const target2 = direction === 'LONG' ? entry + (risk * 2) : entry - (risk * 2);
      
      // Auto-detect strategy
      let strategy = 'SCALP';
      try {
        const response = await fetch(`/api/analyze/${symbol}?intervals=4h,1h,15m`);
        const data = await response.json();
        const signal = data.signal || data.tradeSignal;
        if (signal && signal.setupType) {
          const setupType = signal.setupType.toUpperCase();
          if (setupType.includes('4H')) strategy = '4H';
          else if (setupType.includes('SWING')) strategy = 'SWING';
          else if (setupType.includes('MICRO')) strategy = 'MICROSCALP';
        }
      } catch (error) {
        console.log('Could not auto-detect strategy, using SCALP');
      }
      
      const trade = {
        id: Date.now(),
        symbol: symbol,
        direction: direction,
        entry: entry,
        stopLoss: stopLoss,
        target1: target1,
        target2: target2,
        strategy: strategy,
        riskPercent: 1,
        notes: '',
        journal: journal,
        imageUrl: uploadedImageUrl,
        entryTime: new Date().toISOString(),
        status: 'ACTIVE',
        exitPrice: null,
        exitTime: null,
        outcome: null,
        timestamp: firebase.firestore && firebase.firestore.FieldValue ? firebase.firestore.FieldValue.serverTimestamp() : new Date()
      };
      
      console.log('‚ûï Adding new trade:', trade);
      trades.push(trade);
      console.log('üìä Total trades now:', trades.length);
      
      saveTrades();
      renderTrades();
      
      // Reset form and preview
      document.getElementById('addTradeForm').reset();
      document.getElementById('tradePreview').style.display = 'none';
      document.getElementById('addTradeModal').style.display = 'none';
      calculatedTrade = null;
      
      // Clear uploaded image URL
      const imageUrlField = document.getElementById('uploadedImageUrl');
      if (imageUrlField) {
        imageUrlField.remove();
      }
      
      // Show success message
      alert(`‚úÖ ${trade.direction} trade added for ${trade.symbol.replace('USDT', '')}!`);
    });
    
    // Save trades to Firebase or localStorage
    async function saveTrades() {
      if (db) {
        try {
          // Save each trade to Firestore
          for (const trade of trades) {
            if (trade.id) {
              await db.collection('trades').doc(String(trade.id)).set(trade);
            }
          }
          console.log('üíæ Saved trades to Firebase:', trades.length, 'trades');
        } catch (error) {
          console.error('‚ùå Error saving to Firebase:', error);
          // Fallback to localStorage
          localStorage.setItem('trackedTrades', JSON.stringify(trades));
        }
      } else {
        // Fallback to localStorage
        localStorage.setItem('trackedTrades', JSON.stringify(trades));
        console.log('üíæ Saved trades to localStorage:', trades.length, 'trades');
      }
    }
    
    // Load trades from Firebase or localStorage
    async function loadTrades() {
      if (db) {
        try {
          const snapshot = await db.collection('trades').orderBy('timestamp', 'desc').get();
          trades = [];
          snapshot.forEach(doc => {
            trades.push(doc.data());
          });
          console.log('üì¶ Loaded', trades.length, 'trades from Firebase');
          return trades;
        } catch (error) {
          console.error('‚ùå Error loading from Firebase:', error);
          // Fallback to localStorage
          trades = JSON.parse(localStorage.getItem('trackedTrades') || '[]');
          console.log('üì¶ Loaded', trades.length, 'trades from localStorage (fallback)');
          return trades;
        }
      } else {
        // Fallback to localStorage
        trades = JSON.parse(localStorage.getItem('trackedTrades') || '[]');
        console.log('üì¶ Loaded', trades.length, 'trades from localStorage');
        return trades;
      }
    }
    
    // Fetch current price
    async function fetchPrice(symbol) {
      try {
        const response = await fetch(`/api/analyze/${symbol}?intervals=1m`);
        const data = await response.json();
        return data.currentPrice || priceCache[symbol] || 0;
      } catch (error) {
        console.error('Error fetching price:', error);
        return priceCache[symbol] || 0;
      }
    }
    
    // Start price updates
    async function startPriceUpdates() {
      // Update prices every 5 seconds
      setInterval(async () => {
        const activeTrades = trades.filter(t => t.status === 'ACTIVE');
        for (const trade of activeTrades) {
          const currentPrice = await fetchPrice(trade.symbol);
          if (currentPrice > 0) {
            priceCache[trade.symbol] = currentPrice;
            checkTradeStatus(trade, currentPrice);
          }
        }
        renderTrades();
      }, 5000);
    }
    
    // Check if trade hit stop or target
    function checkTradeStatus(trade, currentPrice) {
      if (trade.status !== 'ACTIVE') return;
      
      if (trade.direction === 'LONG') {
        // Check stop loss
        if (currentPrice <= trade.stopLoss) {
          trade.status = 'CLOSED';
          trade.outcome = 'LOSS';
          trade.exitPrice = trade.stopLoss;
          trade.exitTime = new Date().toISOString();
          saveTrades();
          return;
        }
        // Check targets
        if (trade.target2 && currentPrice >= trade.target2) {
          trade.status = 'CLOSED';
          trade.outcome = 'WIN';
          trade.exitPrice = trade.target2;
          trade.exitTime = new Date().toISOString();
          saveTrades();
          return;
        }
        if (currentPrice >= trade.target1) {
          trade.status = 'CLOSED';
          trade.outcome = 'WIN';
          trade.exitPrice = trade.target1;
          trade.exitTime = new Date().toISOString();
          saveTrades();
          return;
        }
      } else {
        // SHORT
        if (currentPrice >= trade.stopLoss) {
          trade.status = 'CLOSED';
          trade.outcome = 'LOSS';
          trade.exitPrice = trade.stopLoss;
          trade.exitTime = new Date().toISOString();
          saveTrades();
          return;
        }
        if (trade.target2 && currentPrice <= trade.target2) {
          trade.status = 'CLOSED';
          trade.outcome = 'WIN';
          trade.exitPrice = trade.target2;
          trade.exitTime = new Date().toISOString();
          saveTrades();
          return;
        }
        if (currentPrice <= trade.target1) {
          trade.status = 'CLOSED';
          trade.outcome = 'WIN';
          trade.exitPrice = trade.target1;
          trade.exitTime = new Date().toISOString();
          saveTrades();
          return;
        }
      }
    }
    
    // AI market analysis storage
    let marketAnalysis = {};
    
    // Fetch and analyze market data for a trade
    async function analyzeMarketForTrade(trade, currentPrice) {
      try {
        const response = await fetch(`/api/analyze/${trade.symbol}?intervals=4h,1h,15m`);
        const data = await response.json();
        
        // Extract key market indicators
        const signal = data.signal || data.tradeSignal || {};
        const momentum = signal.momentum || 'NEUTRAL';
        const trend = signal.bias || signal.direction || 'NEUTRAL';
        const confidence = signal.confidence || 0;
        
        marketAnalysis[trade.id] = {
          momentum,
          trend,
          confidence,
          timestamp: Date.now()
        };
        
        console.log(`üìä Market analysis for ${trade.symbol}:`, marketAnalysis[trade.id]);
      } catch (error) {
        console.log(`‚ö†Ô∏è Could not fetch market data for ${trade.symbol}:`, error);
        marketAnalysis[trade.id] = { momentum: 'NEUTRAL', trend: 'NEUTRAL', confidence: 0 };
      }
    }
    
    // Generate AI feedback with market context
    function generateFeedback(trade, currentPrice) {
      // If no current price, use entry price (no P&L yet)
      if (!currentPrice || currentPrice === 0) {
        currentPrice = trade.entry;
      }
      
      const risk = Math.abs(trade.entry - trade.stopLoss);
      const pnl = trade.direction === 'LONG' ? 
        (currentPrice - trade.entry) :
        (trade.entry - currentPrice);
      const pnlPercent = (pnl / trade.entry) * 100;
      const rMultiple = pnl / risk;
      
      console.log(`üìä P&L Calc for ${trade.symbol}:`, {
        currentPrice,
        entry: trade.entry,
        direction: trade.direction,
        pnl,
        pnlPercent: pnlPercent.toFixed(2) + '%',
        rMultiple: rMultiple.toFixed(2) + 'R'
      });
      
      // Get market analysis
      const market = marketAnalysis[trade.id] || { momentum: 'NEUTRAL', trend: 'NEUTRAL', confidence: 0 };
      
      let feedbackText = '';
      let signal = ''; // 5-word max summary
      
      if (trade.status === 'CLOSED') {
        const outcome = trade.outcome === 'WIN' ? '‚úÖ Trade closed in profit' : '‚ùå Trade closed at stop loss';
        feedbackText = `${outcome}. Final result: ${rMultiple.toFixed(2)}R (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%). ${trade.outcome === 'WIN' ? 'Well executed. This trade followed your plan and reached its target. Review what confluence factors confirmed this setup to repeat success.' : 'Part of the process - every losing trade teaches you what not to do. The market invalidated this setup, which is why risk management exists. Move on to the next opportunity with a clear head.'}`;
        signal = trade.outcome === 'WIN' ? 'CLOSED PROFIT' : 'CLOSED LOSS';
      } else {
        // Check if market aligns with position
        const marketAligned = (trade.direction === 'LONG' && market.trend === 'BULLISH') ||
                             (trade.direction === 'SHORT' && market.trend === 'BEARISH');
        
        // Distance to targets
        const distanceToTP1 = Math.abs(currentPrice - trade.target1);
        const distanceToStop = Math.abs(currentPrice - trade.stopLoss);
        const distanceToEntry = Math.abs(currentPrice - trade.entry);
        
        // Active trade analysis with detailed reasoning
        if (rMultiple >= 1.5) {
          signal = 'TAKE PROFIT NOW';
          feedbackText = `<strong>Strong profit at +${rMultiple.toFixed(2)}R (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)</strong><br><br>
            <strong>Why this signal:</strong> You've exceeded 1.5R profit, which is a significant win. At this point, the risk of giving back profits increases.<br><br>
            <strong>Market context:</strong> Current market is ${market.trend} with ${market.momentum} momentum. ${marketAligned ? 'Your position is aligned with the trend, but profit-taking is still wise at these levels.' : 'Market momentum is shifting away from your position, making this an ideal exit.'}<br><br>
            <strong>Action items:</strong><br>
            ‚Ä¢ Scale out at least 50-75% of your position here<br>
            ‚Ä¢ Move your stop loss to breakeven or better<br>
            ‚Ä¢ If holding remaining position, set alerts at your next target<br>
            ‚Ä¢ Don't regret taking profit - a realized gain is always better than a reversal`;
        } else if (rMultiple >= 0.8) {
          signal = marketAligned ? 'HOLD FOR MORE' : 'SECURE PROFITS';
          feedbackText = `<strong>Good profit at +${rMultiple.toFixed(2)}R (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)</strong><br><br>
            <strong>Why this signal:</strong> You're near your TP1 target (${rr1.toFixed(1)}R). ${marketAligned ? 'Market is confirming your setup and showing continuation potential.' : 'Market is showing weakness despite your profit, signaling potential reversal.'}<br><br>
            <strong>Market context:</strong> ${marketAligned ? `Trend is ${market.trend} and momentum is ${market.momentum}, both supporting your ${trade.direction} position. Your original thesis is still valid.` : `Market showing ${market.trend} trend, which conflicts with your ${trade.direction} position. Momentum is ${market.momentum}, suggesting the move may be exhausting.`}<br><br>
            <strong>Action items:</strong><br>
            ${marketAligned ? 
              '‚Ä¢ Consider taking 25-50% profit here to lock in gains<br>‚Ä¢ Move stop to breakeven to protect capital<br>‚Ä¢ Hold remaining position for TP2 ('+rr2.toFixed(1)+'R)<br>‚Ä¢ Watch for continuation signals on your timeframe' : 
              '‚Ä¢ Take profit on at least 50-75% of position<br>‚Ä¢ Tighten stops significantly<br>‚Ä¢ Market not confirming - don\'t be greedy<br>‚Ä¢ A profit secured now beats a reversal later'}<br><br>
            <strong>Risk assessment:</strong> $${distanceToStop.toFixed(2)} away from stop loss. Currently $${distanceToTP1.toFixed(2)} from TP1.`;
        } else if (rMultiple >= 0.3) {
          signal = marketAligned ? 'TRUST YOUR SETUP' : 'WATCH CLOSELY';
          feedbackText = `<strong>Trade showing profit at +${rMultiple.toFixed(2)}R (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)</strong><br><br>
            <strong>Why this signal:</strong> You're in profit but not yet at major targets. ${marketAligned ? 'Your setup is playing out as expected with market confirmation.' : 'Market is not strongly confirming your direction, requiring closer monitoring.'}<br><br>
            <strong>Market context:</strong> Current market trend is ${market.trend} with ${market.momentum} momentum (confidence: ${market.confidence}%). ${marketAligned ? 'This aligns with your '+trade.direction+' position, suggesting your entry timing was good. Trust your analysis and let it run to targets.' : 'This creates some conflict with your '+trade.direction+' position. While you\'re profitable, the market isn\'t giving strong confirmation of continuation.'}<br><br>
            <strong>Action items:</strong><br>
            ${marketAligned ?
              '‚Ä¢ Let the trade run - don\'t exit early on minor chop<br>‚Ä¢ Your targets are TP1: $'+trade.target1.toLocaleString()+' ('+rr1.toFixed(1)+'R), TP2: $'+trade.target2.toLocaleString()+' ('+rr2.toFixed(1)+'R)<br>‚Ä¢ Keep stop at entry ($'+trade.stopLoss.toLocaleString()+') until TP1 hit<br>‚Ä¢ Avoid checking every 5 minutes - trust your plan' :
              '‚Ä¢ Monitor this closely - set alerts on key levels<br>‚Ä¢ Prepare to exit if market momentum continues against you<br>‚Ä¢ Consider taking profit early if setup shows further invalidation<br>‚Ä¢ Don\'t hold stubbornly if confluence breaks down'}<br><br>
            <strong>Distance to targets:</strong> TP1 is $${distanceToTP1.toFixed(2)} away. Currently $${distanceToEntry.toFixed(2)} from your entry.`;
        } else if (rMultiple > -0.2) {
          signal = marketAligned ? 'NORMAL PULLBACK' : 'SETUP FAILING';
          feedbackText = `<strong>Price near entry at ${rMultiple.toFixed(2)}R (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)</strong><br><br>
            <strong>Why this signal:</strong> You're essentially at breakeven. ${marketAligned ? 'This is normal retracement behavior in trending markets. Your stop loss exists for a reason - let it do its job.' : 'Market is not confirming your setup. Price is struggling to move in your direction, which is a yellow flag.'}<br><br>
            <strong>Market context:</strong> Market is ${market.trend} with ${market.momentum} momentum. ${marketAligned ? 'Even though trend supports you, price needs time to develop. Pullbacks are healthy and expected - this is why you placed your stop where you did.' : 'Market structure is not supporting your position. You entered expecting '+trade.direction+' movement, but price is not cooperating. This could be a failed setup.'}<br><br>
            <strong>Action items:</strong><br>
            ${marketAligned ?
              '‚Ä¢ This is normal - do NOT panic exit<br>‚Ä¢ Your stop is at $'+trade.stopLoss.toLocaleString()+' for a reason<br>‚Ä¢ Trust your plan and let the setup develop<br>‚Ä¢ If stopped out, it means the trade invalidated (correct outcome)<br>‚Ä¢ Avoid the urge to move stops or "break even"' :
              '‚Ä¢ Watch very closely - this setup may be failing<br>‚Ä¢ If you have a discretionary exit rule (structure break, momentum shift), consider using it<br>‚Ä¢ Prepare mentally to take the loss if stopped<br>‚Ä¢ Better to take a small loss than a large one<br>‚Ä¢ Re-evaluate if your entry was premature'}<br><br>
            <strong>Critical levels:</strong> Stop loss at $${trade.stopLoss.toLocaleString()} ($${distanceToStop.toFixed(2)} away). Entry was $${trade.entry.toLocaleString()}.`;
        } else if (rMultiple > -0.5) {
          signal = 'CUT LOSS SOON';
          feedbackText = `<strong>‚ö†Ô∏è Trade underwater at ${rMultiple.toFixed(2)}R (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)</strong><br><br>
            <strong>Why this signal:</strong> You're in drawdown but haven't hit your stop yet. ${marketAligned ? 'Even though the broader trend supports your direction, this particular entry isn\'t working out. That\'s trading - timing matters.' : 'Market is moving against you and your thesis is being invalidated. The setup you entered is breaking down.'}<br><br>
            <strong>Market context:</strong> Market showing ${market.trend} trend with ${market.momentum} momentum. ${marketAligned ? 'While the trend eventually may resume in your favor, this specific entry is underwater. Sometimes even good setups in trending markets fail due to timing or liquidity sweeps. Don\'t fight the tape if it continues against you.' : 'Market structure is clearly not supporting your position. Your '+trade.direction+' bias is not playing out. The confluence you relied on has broken down.'}<br><br>
            <strong>Action items:</strong><br>
            ‚Ä¢ Prepare mentally to take this loss - it's part of trading<br>
            ‚Ä¢ Do NOT move your stop loss further away (that's emotional trading)<br>
            ‚Ä¢ If you have a discretionary exit rule and it's triggered, cut now<br>
            ‚Ä¢ Your stop is at $${trade.stopLoss.toLocaleString()} - only $${distanceToStop.toFixed(2)} away<br>
            ‚Ä¢ Review what went wrong: Was entry timing off? Did market structure shift?<br>
            ‚Ä¢ Accept that not every setup works - risk management exists for this<br><br>
            <strong>Risk assessment:</strong> You're down ${Math.abs(pnlPercent).toFixed(2)}%. Stop loss will limit this to ${Math.abs((trade.stopLoss - trade.entry) / trade.entry * 100).toFixed(2)}% loss. That's why stops exist.`;
        } else if (rMultiple > -0.8) {
          signal = 'EXIT IMMEDIATELY';
          feedbackText = `<strong>üö® Major drawdown at ${rMultiple.toFixed(2)}R (${pnlPercent.toFixed(2)}%)</strong><br><br>
            <strong>Why this signal:</strong> You're in significant drawdown approaching your stop loss. ${trade.stopLoss ? 'Your stop is about to be hit, which means the setup has completely failed.' : '‚ö†Ô∏è CRITICAL: You have no stop loss set, which is extremely dangerous. You should have exited long ago.'}<br><br>
            <strong>Market context:</strong> Market is ${market.trend} with ${market.momentum} momentum. ${marketAligned ? 'Even though the trend generally aligns, THIS trade entry was wrong. The market can be right while you\'re still wrong on timing or execution.' : 'Market is clearly moving against your '+trade.direction+' position. Your thesis was incorrect or the market structure shifted after entry.'}<br><br>
            <strong>URGENT action items:</strong><br>
            ${trade.stopLoss ? 
              '‚Ä¢ Accept this loss is happening - your stop is about to hit<br>‚Ä¢ Do NOT move your stop (that\'s the #1 mistake traders make)<br>‚Ä¢ If you manually exit now vs letting stop hit, you save a few dollars of slippage<br>‚Ä¢ Prepare to review what went wrong AFTER you exit<br>‚Ä¢ Every losing trade is education - learn from it' :
              '‚Ä¢ üö® EXIT IMMEDIATELY - you have no stop loss protection<br>‚Ä¢ You are in freefall without risk management<br>‚Ä¢ Every second you delay, losses compound<br>‚Ä¢ SET A STOP LOSS on your next trade - this is non-negotiable<br>‚Ä¢ Never trade without stops again'}<br><br>
            <strong>Loss projection:</strong> Currently down ${Math.abs(pnlPercent).toFixed(2)}%. ${trade.stopLoss ? 'Stop will limit to '+(Math.abs((trade.stopLoss - trade.entry) / trade.entry * 100).toFixed(2))+'% max loss.' : 'NO STOP SET - losses unlimited!'}`;
        } else {
          signal = 'GET OUT NOW';
          feedbackText = `<strong>üí• CRITICAL LOSS at ${rMultiple.toFixed(2)}R (${pnlPercent.toFixed(2)}%)</strong><br><br>
            <strong>Why this signal:</strong> ${trade.stopLoss ? 'Your stop loss is being hit or has been hit. This trade is completely invalidated and needs to be closed immediately.' : 'üí• EMERGENCY: You have NO STOP LOSS and are in freefall. This is catastrophic risk management failure.'}<br><br>
            <strong>Market reality:</strong> Market is ${market.trend} (${market.momentum}). Your ${trade.direction} position is fundamentally wrong. ${marketAligned ? 'Even if trend eventually agrees with you, THIS entry failed. You cannot hold through massive drawdown hoping for a bounce.' : 'You are fighting the market and losing. Market structure completely invalidated your thesis.'}<br><br>
            <strong>EMERGENCY ACTIONS - DO NOW:</strong><br>
            ${trade.stopLoss ?
              '‚Ä¢ CLOSE THIS TRADE IMMEDIATELY<br>‚Ä¢ Your stop should have been hit - close manually if it didn\'t<br>‚Ä¢ Accept the loss - it\'s already happened<br>‚Ä¢ Do not average down, do not "wait for bounce"<br>‚Ä¢ Take the loss and move on with capital preservation mindset' :
              '‚Ä¢ üö®üö®üö® EMERGENCY EXIT REQUIRED üö®üö®üö®<br>‚Ä¢ You have NO STOP LOSS - losses are UNLIMITED<br>‚Ä¢ CLOSE NOW before you lose more<br>‚Ä¢ This is NOT optional - EXIT IMMEDIATELY<br>‚Ä¢ Never, EVER trade without a stop loss again<br>‚Ä¢ You are risking total account blow-up'}<br><br>
            <strong>Current damage:</strong> Down ${Math.abs(pnlPercent).toFixed(2)}%. ${trade.stopLoss ? 'Max designed loss was '+Math.abs((trade.stopLoss - trade.entry) / trade.entry * 100).toFixed(2)+'%.' : 'NO STOP = losses spiraling out of control.'}<br><br>
            <strong>After you exit:</strong> Step away from the screen. Review what went wrong. Learn from this. Come back with a clear head and ALWAYS use stop losses.`;
        }
      }
      
      return { feedbackText, rMultiple, pnlPercent, signal };
    }
    
    // Create trade row (matching homepage coin row structure)
    function createTradeRow(trade) {
      const currentPrice = priceCache[trade.symbol] || 0;
      const { feedbackText, rMultiple, pnlPercent, signal } = generateFeedback(trade, currentPrice);
      
      // Coin names
      const coinNames = {
        'BTCUSDT': 'BITCOIN',
        'ETHUSDT': 'ETHEREUM',
        'SOLUSDT': 'SOLANA'
      };
      const coinName = coinNames[trade.symbol] || trade.symbol.replace('USDT', '');
      
      // Coin name always yellow-white
      const coinNameColor = 'var(--color-yellow-75)';
      
      // Coin row
      const row = document.createElement('tr');
      row.id = `trade-row-${trade.id}`;
      
      // Check if we have valid price data
      const hasValidPrice = currentPrice > 0 && currentPrice !== trade.entry;
      
      // Row background: green if profit, red if loss, neutral if closed or loading
      let rowBgClass = '';
      if (trade.status === 'ACTIVE' && hasValidPrice) {
        rowBgClass = pnlPercent >= 0 ? 'has-trade-long' : 'has-trade-short';
      }
      row.className = `coin-row ${rowBgClass}`;
      
      // P&L text color: green if profit, red if loss, yellow-white if loading
      const pnlColor = hasValidPrice ? (pnlPercent >= 0 ? '#22c55e' : '#ef4444') : 'var(--color-yellow-75)';
      
      // All text in yellow-white
      const signalColor = 'var(--color-yellow-75)';
      
      row.innerHTML = `
        <td class="px-2 coin-name-cell" style="padding-top: 1rem; padding-bottom: 1rem; width: 150px; min-width: 150px; max-width: 150px;">
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div style="font-family: var(--font-mathias); font-weight: bold; font-size: 0.9rem; color: ${coinNameColor}; text-align: center;">
              ${coinName}
            </div>
          </div>
        </td>
        
        <td class="px-2" data-label="P&L:" style="width: 100px; min-width: 100px; max-width: 100px; white-space: nowrap; padding-left: 1rem;">
          <div style="font-family: var(--font-mathias); font-weight: bold; color: ${pnlColor}; font-size: 0.85rem; text-align: left;">
            ${hasValidPrice ? `${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%` : '--'}
          </div>
        </td>
        
        <td class="px-2" data-label="Status:" style="padding-left: 1rem;">
          <div style="font-family: var(--font-mathias); font-weight: bold; font-size: 0.85rem; color: ${signalColor}; text-align: left;">
            ${hasValidPrice ? signal : '--'}
          </div>
        </td>
        
        <td class="px-2 details-button-cell" data-label="Details:" style="width: 120px; min-width: 120px; max-width: 120px; white-space: nowrap;">
          <button 
            onclick="toggleTradeDetails(${trade.id})"
            class="btn-base btn-secondary px-3 py-1 text-xs rounded details-button"
            style="font-family: var(--font-mathias); font-weight: bold; background-color: var(--color-yellow-75); color: #000000; border-color: var(--color-yellow-75); padding: 0.5rem 1rem;"
          >
            DETAILS
          </button>
        </td>
      `;
      
      return row;
    }
    
    // Create details row (matching homepage details structure)
    function createTradeDetailsRow(trade) {
      const currentPrice = priceCache[trade.symbol] || 0;
      const { feedbackText, rMultiple, pnlPercent, signal } = generateFeedback(trade, currentPrice);
      const risk = Math.abs(trade.entry - trade.stopLoss);
      
      const detailsRow = document.createElement('tr');
      detailsRow.id = `trade-details-${trade.id}`;
      detailsRow.className = 'details-row';
      
      const directionColor = trade.direction === 'LONG' ? '#22c55e' : '#ef4444';
      const directionIcon = trade.direction === 'LONG' ? 'üü¢‚¨ÜÔ∏è' : 'üî¥‚¨áÔ∏è';
      const setupType = trade.strategy.toUpperCase();
      
      // Get market analysis context
      const market = marketAnalysis[trade.id] || { momentum: 'NEUTRAL', trend: 'NEUTRAL', confidence: 0 };
      const marketAligned = (trade.direction === 'LONG' && market.trend === 'BULLISH') ||
                           (trade.direction === 'SHORT' && market.trend === 'BEARISH');
      
      // Calculate R-multiples for targets
      const rr1 = Math.abs((trade.target1 - trade.entry) / risk);
      const rr2 = Math.abs((trade.target2 - trade.entry) / risk);
      
      
      detailsRow.innerHTML = `
        <td colspan="4">
          <div class="details-content-wrapper">
            <!-- Trade Call Output (matching homepage) -->
            <div style="margin-bottom: 1.5rem; padding: 1.5rem; background-color: rgba(0, 0, 0, 0.6); border-radius: var(--radius-md); font-family: var(--font-system); backdrop-filter: blur(10px);">
              
              <!-- Header -->
              <div style="margin-bottom: 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 1rem;">
                <h2 style="font-size: clamp(1.25rem, 4vw, 1.75rem); font-weight: bold; color: var(--color-yellow-75); margin-bottom: 0.75rem; letter-spacing: 0.05em; text-transform: uppercase; font-family: var(--font-mathias);">
                  ${trade.symbol.replace('USDT', '')} ‚Äî ${trade.direction} (${setupType})
                </h2>
                
                <!-- Key Metrics Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem;">
                  <div>
                    <div style="color: var(--color-yellow-75); font-size: 0.75rem; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em; font-family: var(--font-mathias);">Current Price</div>
                    <div style="color: ${directionColor}; font-size: 1.5rem; font-weight: bold;">$${currentPrice.toLocaleString()}</div>
                  </div>
                  <div>
                    <div style="color: var(--color-yellow-75); font-size: 0.75rem; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em; font-family: var(--font-mathias);">P&L</div>
                    <div style="color: ${rMultiple >= 0 ? '#22c55e' : '#ef4444'}; font-size: 1.25rem; font-weight: bold;">${rMultiple.toFixed(2)}R (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)</div>
                  </div>
                  <div>
                    <div style="color: var(--color-yellow-75); font-size: 0.75rem; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em; font-family: var(--font-mathias);">Direction</div>
                    <div style="color: ${directionColor}; font-size: 1.25rem; font-weight: bold;">${directionIcon} ${trade.direction}</div>
                  </div>
                </div>
              </div>
              
              <!-- Editorial Grid Layout -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <!-- Left Column: Entry & Risk -->
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                  <div>
                    <div style="color: var(--color-yellow-75); font-weight: bold; font-size: 0.75rem; margin-bottom: 0.5rem; letter-spacing: 0.1em; text-transform: uppercase; font-family: var(--font-mathias);">Entry</div>
                    <div style="color: var(--color-yellow-75); font-size: 1.125rem; font-weight: bold; line-height: 1.2;">$${trade.entry.toLocaleString()}</div>
                  </div>
                  
                  <div>
                    <div style="color: var(--color-yellow-75); font-weight: bold; font-size: 0.75rem; margin-bottom: 0.5rem; letter-spacing: 0.1em; text-transform: uppercase; font-family: var(--font-mathias);">Stop Loss</div>
                    <div style="color: ${trade.direction === 'LONG' ? '#ef4444' : '#22c55e'}; font-size: 1.125rem; font-weight: bold;">$${trade.stopLoss.toLocaleString()}</div>
                  </div>
                  
                  <div>
                    <div style="color: var(--color-yellow-75); font-weight: bold; font-size: 0.75rem; margin-bottom: 0.5rem; letter-spacing: 0.1em; text-transform: uppercase; font-family: var(--font-mathias);">Risk / Reward</div>
                    <div style="color: #22c55e; font-size: 1rem; font-weight: bold; line-height: 1.4;">
                      ${rr1.toFixed(1)}R to ${rr2.toFixed(1)}R
                    </div>
                  </div>
                </div>
                
                <!-- Right Column: Targets & Invalidation -->
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                  <div>
                    <div style="color: var(--color-yellow-75); font-weight: bold; font-size: 0.75rem; margin-bottom: 0.5rem; letter-spacing: 0.1em; text-transform: uppercase; font-family: var(--font-mathias);">Targets</div>
                    <div style="color: var(--color-yellow-75); font-size: 0.875rem; font-weight: bold; line-height: 1.6;">
                      <div>TP1 (${rr1.toFixed(1)}R): $${trade.target1.toLocaleString()}</div>
                      ${trade.target2 ? `<div style="margin-top: 0.25rem;">TP2 (${rr2.toFixed(1)}R): $${trade.target2.toLocaleString()}</div>` : ''}
                    </div>
                  </div>
                  
                  <div>
                    <div style="color: var(--color-yellow-75); font-weight: bold; font-size: 0.75rem; margin-bottom: 0.5rem; letter-spacing: 0.1em; text-transform: uppercase; font-family: var(--font-mathias);">Invalidation</div>
                    <div style="color: var(--color-yellow-75); font-size: 0.875rem; line-height: 1.5;">
                      <div style="margin-bottom: 0.5rem;">
                        ${setupType === 'SWING' ? 'HTF invalidation indicates macro trend shifted.' : 
                          setupType === 'SCALP' ? 'LTF invalidation means scalp failed.' : 
                          setupType === 'MICROSCALP' ? 'Exit immediately if wrong - high risk countertrend.' :
                          'Structure break invalidates setup.'}
                      </div>
                      <div><strong>Level:</strong> $${trade.stopLoss.toLocaleString()} (${trade.direction === 'LONG' ? 'close below' : 'close above'})</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Full Width: AI Trade Management -->
              <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="color: var(--color-yellow-75); font-weight: bold; font-size: 0.75rem; margin-bottom: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; font-family: var(--font-mathias);">AI Trade Management Analysis</div>
                <div style="color: var(--color-yellow-75); font-size: 0.875rem; line-height: 1.8;">
                  ${feedbackText}
                </div>
              </div>
              
              <!-- Full Width: Market Context -->
              <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="color: var(--color-yellow-75); font-weight: bold; font-size: 0.75rem; margin-bottom: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; font-family: var(--font-mathias);">Market Context</div>
                <div style="color: var(--color-yellow-75); font-size: 0.875rem; line-height: 1.8;">
                  <div style="display: flex; flex-direction: column; gap: 0.4rem;">
                    <div><span style="color: rgba(255, 255, 255, 0.5);">‚Äì</span> Market alignment: ${marketAligned ? '‚úì Aligned' : '‚ö†Ô∏è Against'}</div>
                    <div><span style="color: rgba(255, 255, 255, 0.5);">‚Äì</span> Market trend: ${market.trend}</div>
                    <div><span style="color: rgba(255, 255, 255, 0.5);">‚Äì</span> Momentum: ${market.momentum}</div>
                    <div><span style="color: rgba(255, 255, 255, 0.5);">‚Äì</span> Confidence: ${market.confidence}%</div>
                  </div>
                </div>
              </div>
              
              ${trade.journal ? `
              <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="color: var(--color-yellow-75); font-weight: bold; font-size: 0.75rem; margin-bottom: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; font-family: var(--font-mathias);">Trade Journal</div>
                <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.875rem; line-height: 1.6; white-space: pre-wrap;">
                  ${trade.journal}
                </div>
              </div>
              ` : ''}
              
              ${trade.imageUrl ? `
              <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="color: var(--color-yellow-75); font-weight: bold; font-size: 0.75rem; margin-bottom: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; font-family: var(--font-mathias);">Trade Screenshot</div>
                <div style="display: flex; justify-content: center; margin-top: 1rem;">
                  <a href="${trade.imageUrl}" target="_blank" rel="noopener noreferrer">
                    <img src="${trade.imageUrl}" alt="Trade Screenshot" style="max-width: 100%; max-height: 400px; border-radius: 0.5rem; border: 2px solid var(--color-yellow-75);" />
                  </a>
                </div>
              </div>
              ` : ''}
              
              <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1); font-size: 0.75rem; color: var(--text-secondary); font-family: var(--font-system);">
                <p>Entry Time: ${new Date(trade.entryTime).toLocaleString()}</p>
                ${trade.exitTime ? `<p>Exit Time: ${new Date(trade.exitTime).toLocaleString()}</p>` : ''}
              </div>
            </div>
            
            <div style="text-align: center; padding: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
              <button 
                onclick="toggleTradeDetails(${trade.id})"
                class="btn-base btn-secondary px-4 py-2 text-sm rounded"
                style="font-family: var(--font-mathias); font-weight: bold; background-color: var(--color-yellow-75); color: #000000; border-color: var(--color-yellow-75); padding: 0.5rem 1rem;"
              >
                HIDE
              </button>
              <button 
                onclick="deleteTrade(${trade.id})"
                class="btn-base btn-secondary px-4 py-2 text-sm rounded"
                style="font-family: var(--font-mathias); font-weight: bold; background-color: #ef4444; color: #ffffff; border-color: #ef4444; padding: 0.5rem 1rem;"
              >
                DELETE
              </button>
            </div>
          </div>
        </td>
      `;
      
      return detailsRow;
    }
    
    // Track expanded trade details
    let expandedTradeIds = new Set();
    
    // Refresh trades (fetch latest prices and re-analyze)
    window.refreshTrades = async function() {
      console.log('üîÑ Refreshing trades...');
      
      const activeTrades = trades.filter(t => t.status === 'ACTIVE');
      
      if (activeTrades.length === 0) {
        console.log('‚ÑπÔ∏è No active trades to refresh');
        return;
      }
      
      // Show loading state
      const refreshBtn = event.target.closest('button');
      const originalContent = refreshBtn.innerHTML;
      refreshBtn.innerHTML = `
        <svg style="animation: spin 1s linear infinite;" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        <span>REFRESHING...</span>
      `;
      refreshBtn.disabled = true;
      
      try {
        // Fetch latest prices for all active trades
        for (const trade of activeTrades) {
          const currentPrice = await fetchPrice(trade.symbol);
          if (currentPrice > 0) {
            priceCache[trade.symbol] = currentPrice;
            checkTradeStatus(trade, currentPrice);
            console.log(`‚úÖ Updated ${trade.symbol}: $${currentPrice.toLocaleString()}`);
          }
        }
        
        // Re-render with updated prices
        await renderTrades();
        console.log('‚úÖ Refresh complete');
      } catch (error) {
        console.error('‚ùå Refresh failed:', error);
      } finally {
        // Restore button
        refreshBtn.innerHTML = originalContent;
        refreshBtn.disabled = false;
      }
    };
    
    // Toggle trade details
    window.toggleTradeDetails = function(tradeId) {
      const detailsRow = document.getElementById(`trade-details-${tradeId}`);
      const button = event.target.closest('button');
      
      console.log('üîÑ Toggling details for trade:', tradeId);
      
      if (detailsRow.classList.contains('expanded')) {
        detailsRow.classList.remove('expanded');
        expandedTradeIds.delete(tradeId);
        console.log('  ‚ùå Collapsed');
        if (button) button.textContent = 'DETAILS';
      } else {
        detailsRow.classList.add('expanded');
        expandedTradeIds.add(tradeId);
        console.log('  ‚úÖ Expanded');
        if (button) button.textContent = 'HIDE';
      }
    };
    
    // Render all trades
    async function renderTrades() {
      console.log('üîÑ Rendering trades...', trades.length, 'total trades');
      
      const activeTrades = trades.filter(t => t.status === 'ACTIVE');
      const closedTrades = trades.filter(t => t.status === 'CLOSED');
      
      console.log('  Active:', activeTrades.length, '| Closed:', closedTrades.length);
      
      const allTrades = [...activeTrades, ...closedTrades];
      const tradesTable = document.getElementById('tradesTable');
      
      if (!tradesTable) {
        console.error('‚ùå tradesTable element not found!');
        return;
      }
      
      if (allTrades.length === 0) {
        tradesTable.innerHTML = '';
        console.log('  ‚ÑπÔ∏è No trades to display');
      } else {
        // Fetch market analysis for all active trades
        console.log('üìä Fetching market analysis for active trades...');
        const analysisPromises = activeTrades.map(trade => analyzeMarketForTrade(trade, priceCache[trade.symbol] || 0));
        await Promise.all(analysisPromises);
        
        tradesTable.innerHTML = '';
        allTrades.forEach(trade => {
          console.log(`  ‚úì Rendering trade: ${trade.symbol} ${trade.direction} @ $${trade.entry}`);
          const tradeRow = createTradeRow(trade);
          const detailsRow = createTradeDetailsRow(trade);
          tradesTable.appendChild(tradeRow);
          tradesTable.appendChild(detailsRow);
          
          // Restore expanded state if this trade was previously expanded
          if (expandedTradeIds.has(trade.id)) {
            console.log(`  üîì Restoring expanded state for trade ${trade.id}`);
            detailsRow.classList.add('expanded');
            // Update button text
            const button = tradeRow.querySelector('button[onclick*="toggleTradeDetails"]');
            if (button) button.textContent = 'HIDE';
          }
        });
        console.log('‚úÖ All trades rendered');
      }
    }
    
    // Close trade manually
    window.closeTrade = function(tradeId, exitPrice) {
      const trade = trades.find(t => t.id === tradeId);
      if (!trade) return;
      
      const risk = Math.abs(trade.entry - trade.stopLoss);
      const pnl = trade.direction === 'LONG' ? 
        (exitPrice - trade.entry) :
        (trade.entry - exitPrice);
      const rMultiple = pnl / risk;
      
      trade.status = 'CLOSED';
      trade.outcome = rMultiple >= 0 ? 'WIN' : 'LOSS';
      trade.exitPrice = exitPrice;
      trade.exitTime = new Date().toISOString();
      
      saveTrades();
      renderTrades();
    };
    
    // Delete trade
    window.deleteTrade = async function(tradeId) {
      if (!confirm('Are you sure you want to delete this trade? This action cannot be undone.')) {
        return;
      }
      
      console.log('üóëÔ∏è Deleting trade:', tradeId);
      
      // Remove from expanded state
      expandedTradeIds.delete(tradeId);
      
      // Remove from trades array
      const index = trades.findIndex(t => t.id === tradeId);
      if (index !== -1) {
        const deletedTrade = trades.splice(index, 1)[0];
        console.log('‚úÖ Deleted trade:', deletedTrade.symbol, deletedTrade.direction);
        
        // Delete from Firebase
        if (db) {
          try {
            await db.collection('trades').doc(String(tradeId)).delete();
            console.log('üóëÔ∏è Deleted from Firebase');
            
            // Also delete associated image if exists
            if (deletedTrade.imageUrl && storage) {
              try {
                const imageRef = storage.refFromURL(deletedTrade.imageUrl);
                await imageRef.delete();
                console.log('üóëÔ∏è Deleted trade image from Firebase Storage');
              } catch (imgError) {
                console.warn('‚ö†Ô∏è Could not delete image:', imgError);
              }
            }
          } catch (error) {
            console.error('‚ùå Error deleting from Firebase:', error);
          }
        }
        
        await saveTrades();
        renderTrades();
      } else {
        console.error('‚ùå Trade not found:', tradeId);
      }
    };
    
    // Handle file upload
    window.handleFileUpload = async function(event) {
      console.log('üì§ File upload triggered');
      const file = event.target.files[0];
      if (!file) {
        console.log('‚ö†Ô∏è No file selected');
        return;
      }
      
      console.log('üìÅ File selected:', file.name, file.type, file.size);
      
      // Check if it's an image
      if (!file.type.startsWith('image/')) {
        console.log('‚ùå Not an image file');
        alert('Please upload an image file (PNG, JPG, etc.)');
        event.target.value = '';
        return;
      }
      
      // Show loading indicator
      const uploadBtn = event.target.parentElement.querySelector('div');
      const originalContent = uploadBtn.innerHTML;
      uploadBtn.innerHTML = `
        <svg style="animation: spin 1s linear infinite;" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        <span>ANALYZING IMAGE...</span>
      `;
      
      try {
        // Upload image to Firebase Storage first
        let uploadedImageUrl = null;
        if (storage) {
          try {
            const timestamp = Date.now();
            const fileName = `trade_images/${timestamp}_${file.name}`;
            const storageRef = storage.ref(fileName);
            
            console.log('üì§ Uploading image to Firebase Storage...');
            const uploadTask = await storageRef.put(file);
            uploadedImageUrl = await uploadTask.ref.getDownloadURL();
            console.log('‚úÖ Image uploaded to Firebase:', uploadedImageUrl);
          } catch (storageError) {
            console.error('‚ùå Error uploading to Firebase Storage:', storageError);
            alert('‚ö†Ô∏è Image upload failed, but we\'ll try to parse it anyway.');
          }
        }
        
        // Convert image to base64
        const reader = new FileReader();
        reader.onload = async function(e) {
          const base64Data = e.target.result;
          
          try {
            console.log('üöÄ Sending image to API...');
            // Send to API
            const response = await fetch('/api/parse-trade-image', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                imageData: base64Data
              })
            });
            
            console.log('üì• API response status:', response.status);
            const result = await response.json();
            console.log('üìä API result:', result);
            
            if (!response.ok) {
              throw new Error(result.error || 'Failed to parse image');
            }
            
            // Auto-fill form with extracted data
            const data = result.data;
            
            if (data.symbol) {
              document.getElementById('symbol').value = data.symbol;
            }
            
            if (data.direction) {
              document.getElementById('direction').value = data.direction;
            }
            
            if (data.entry) {
              document.getElementById('entry').value = data.entry;
            }
            
            if (data.stopLoss) {
              document.getElementById('stopLoss').value = data.stopLoss;
            }
            
            // Store uploaded image URL in a hidden field
            if (uploadedImageUrl) {
              let imageUrlField = document.getElementById('uploadedImageUrl');
              if (!imageUrlField) {
                imageUrlField = document.createElement('input');
                imageUrlField.type = 'hidden';
                imageUrlField.id = 'uploadedImageUrl';
                document.getElementById('addTradeForm').appendChild(imageUrlField);
              }
              imageUrlField.value = uploadedImageUrl;
              console.log('üíæ Stored image URL for trade submission');
            }
            
            // Trigger preview update
            await updateTradePreview();
            
            // Show success message
            const fieldsFound = [];
            if (data.symbol) fieldsFound.push('Symbol');
            if (data.direction) fieldsFound.push('Direction');
            if (data.entry) fieldsFound.push('Entry');
            if (data.stopLoss) fieldsFound.push('Stop Loss');
            
            alert(`‚úÖ Trade details extracted!\n\nFound: ${fieldsFound.join(', ')}\n\nPlease review the values before submitting.`);
            
          } catch (error) {
            console.error('Error parsing image:', error);
            alert(`‚ùå Could not extract trade details from image.\n\n${error.message}\n\nPlease enter manually or try a clearer screenshot.`);
          } finally {
            // Restore button
            uploadBtn.innerHTML = originalContent;
          }
        };
        
        reader.readAsDataURL(file);
        
      } catch (error) {
        console.error('Error reading file:', error);
        alert('Error reading file. Please try again.');
        uploadBtn.innerHTML = originalContent;
      }
      
      // Reset file input
      event.target.value = '';
    };
  </script>

  <!-- Particles.js Library -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <script>
    // Initialize particle system
    particlesJS('particles-js', {
      particles: {
        number: {
          value: 500,
          density: {
            enable: true,
            value_area: 800
          }
        },
        color: {
          value: '#ffffff'
        },
        shape: {
          type: 'circle'
        },
        opacity: {
          value: 0.5,
          random: true,
          anim: {
            enable: true,
            speed: 1,
            opacity_min: 0.1,
            sync: false
          }
        },
        size: {
          value: 2,
          random: true,
          anim: {
            enable: true,
            speed: 2,
            size_min: 0.1,
            sync: false
          }
        },
        line_linked: {
          enable: false
        },
        move: {
          enable: true,
          speed: 0.5,
          direction: 'none',
          random: true,
          straight: false,
          out_mode: 'out',
          bounce: false
        }
      },
      interactivity: {
        detect_on: 'canvas',
        events: {
          onhover: {
            enable: false
          },
          onclick: {
            enable: false
          },
          resize: true
        }
      },
      retina_detect: true
    });
  </script>
</body>
</html>

